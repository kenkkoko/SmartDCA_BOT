<!DOCTYPE html>
<html lang="zh-TW">

<head>
    Â  Â 
    <meta charset="UTF-8">
    Â  Â 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    Â  Â  <title>Smart DCA Bot - ææ‡¼è²ªå©ªæŒ‡æ•¸ç­–ç•¥</title>
    Â  Â 
    <link rel="icon" type="image/png" href="./app-icon.png" />


    Â  Â  <!-- å¼•å…¥ Tailwind CSS -->
    Â  Â 
    <script src="https://cdn.tailwindcss.com"></script>

    Â  Â  <!-- å¼•å…¥ React å’Œ ReactDOM -->
    Â  Â 
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    Â  Â 
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    Â  Â  <!-- å¼•å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    Â  Â 
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    Â  Â  <!-- å¼•å…¥ Chart.js (ç¢ºä¿ä½¿ç”¨ UMD ç‰ˆæœ¬) -->
    Â  Â 
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

    Â  Â  <style>
        body {
            background-color: #0f172a;
            /* slate-950 */
        }

        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* ç§»é™¤èˆŠçš„æŒ‡é‡ CSSï¼Œä½¿ç”¨ SVG å…§å»ºå‹•ç•« */
    </style>
</head>

<body>
    Â  Â  <div id="root"></div>

    Â  Â 
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- å…§å»º Icons (å–ä»£å¤–éƒ¨ lucide-react ä¾è³´) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width={size}
                height={size}
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const Icons = {
            Bell: (props) => (
                <IconBase {...props}>
                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
                </IconBase>
            ),
            TrendingUp: (props) => (
                <IconBase {...props}>
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                    <polyline points="17 6 23 6 23 12" />
                </IconBase>
            ),
            AlertTriangle: (props) => (
                <IconBase {...props}>
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                    <line x1="12" y1="9" x2="12" y2="13" />
                    <line x1="12" y1="17" x2="12.01" y2="17" />
                </IconBase>
            ),
            Info: (props) => (
                <IconBase {...props}>
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="16" x2="12" y2="12" />
                    <line x1="12" y1="8" x2="12.01" y2="8" />
                </IconBase>
            ),
            RefreshCw: (props) => (
                <IconBase {...props}>
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
                    <path d="M21 3v5h-5" />
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
                    <path d="M8 16H3v5" />
                </IconBase>
            ),
            Smartphone: (props) => (
                <IconBase {...props}>
                    <rect width="14" height="20" x="5" y="2" rx="2" ry="2" />
                    <path d="M12 18h.01" />
                </IconBase>
            ),
            ArrowUp: (props) => (
                <IconBase {...props}>
                    <line x1="12" y1="19" x2="12" y2="5" />
                    <polyline points="5 12 12 5 19 12" />
                </IconBase>
            ),
            ArrowDown: (props) => (
                <IconBase {...props}>
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <polyline points="19 12 12 19 5 12" />
                </IconBase>
            ),
            Newspaper: (props) => (
                <IconBase {...props}>
                    <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" />
                    <path d="M18 14h-8" />
                    <path d="M15 18h-5" />
                    <path d="M10 6h8v4h-8V6Z" />
                </IconBase>
            ),
            Sparkles: (props) => (
                <IconBase {...props}>
                    <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                </IconBase>
            ),
            ExternalLink: (props) => (
                <IconBase {...props}>
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                    <polyline points="15 3 21 3 21 9" />
                    <line x1="10" y1="14" x2="21" y2="3" />
                </IconBase>
            ),
            Bot: (props) => (
                <IconBase {...props}>
                    <path d="M12 8V4H8" />
                    <rect width="16" height="12" x="4" y="8" rx="2" />
                    <path d="M2 14h2" />
                    <path d="M20 14h2" />
                    <path d="M15 13v2" />
                    <path d="M9 13v2" />
                </IconBase>
            ),
            Globe: (props) => (
                <IconBase {...props}>
                    <circle cx="12" cy="12" r="10" />
                    <line x1="2" y1="12" x2="22" y2="12" />
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                </IconBase>
            ),
            Activity: (props) => (
                <IconBase {...props}>
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </IconBase>
            ),
            BellRing: (props) => (
                <IconBase {...props}>
                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
                    <path d="M4 2C2.8 3.7 2 5.7 2 8" />
                    <path d="M22 8c0-2.3-.8-4.3-2-6" />
                </IconBase>
            ),
            BellOff: (props) => (
                <IconBase {...props}>
                    <path d="M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5" />
                    <path d="M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7" />
                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
                    <path d="M2 2l20 20" />
                </IconBase>
            )
        };

        const { Bell, TrendingUp, AlertTriangle, Info, RefreshCw, Smartphone, ArrowUp, ArrowDown, Newspaper, Sparkles, ExternalLink, Bot, Globe, Activity, BellRing, BellOff } = Icons;

        // --- ææ‡¼è²ªå©ªæŒ‡æ•¸å„€è¡¨æ¿å…ƒä»¶ ---
        console.log("SmartDCA Version: 1.1 (Debug Mode)");

        // API Key Placeholder for GitHub Actions Injection
        // API Key Placeholder for GitHub Actions Injection
        const GEMINI_API_KEY = '__GEMINI_API_KEY_PLACEHOLDER__';

        // Helper: Format Price (8 decimals for < 1, 2 for >= 1)
        const formatPrice = (price) => {
            if (price === null || price === undefined) return 'N/A';
            if (price < 1) return price.toLocaleString(undefined, { maximumFractionDigits: 8 });
            return price.toLocaleString(undefined, { maximumFractionDigits: 2 });
        };

        // --- Gemini API Helper ---
        const fetchGeminiAdvice = async (prompt) => {
            // Check for key in window object (for user injection) or environment variable placeholder
            let apiKey = GEMINI_API_KEY;
            if (typeof window !== 'undefined' && window.GEMINI_API_KEY && !window.GEMINI_API_KEY.includes('PLACEHOLDER')) {
                apiKey = window.GEMINI_API_KEY;
            }

            if (!apiKey || apiKey.includes('PLACEHOLDER')) {
                console.error("Gemini API Key is missing or invalid.");
                return `âš ï¸ AI æš«æ™‚ç„¡æ³•æä¾›å»ºè­° (æœªè¨­å®š API Key)ã€‚è«‹åœ¨ Actions Secrets è¨­å®šï¼Œæˆ–åœ¨ Console è¼¸å…¥ window.GEMINI_API_KEY='ä½ çš„KEY'`;
            }
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-live:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "âš ï¸ AI æš«æ™‚ç„¡æ³•æä¾›å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        };

        // --- AI Advice Component ---
        const AIAdviceBlock = ({ marketData, assetName, priceStats }) => {
            const [advice, setAdvice] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (marketData) {
                    setLoading(true);
                    const priceInfo = priceStats ? `
                    è³‡ç”¢æ•¸æ“š:
                    - ç•¶å‰åƒ¹æ ¼: $${formatPrice(priceStats.current)}
                    - è¿‘ä¸€å¹´æœ€é«˜: $${formatPrice(priceStats.high)}
                    - è¿‘ä¸€å¹´æœ€ä½: $${formatPrice(priceStats.low)}
                    ` : '';

                    const prompt = `
                    ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æŠ•è³‡é¡§å•ã€‚æ ¹æ“šä»¥ä¸‹ ${assetName} çš„å¸‚å ´æ•¸æ“šï¼Œæä¾›ä¸€å€‹ç°¡çŸ­çš„ DCA (å¹³å‡æˆæœ¬æ³•) æ“ä½œå»ºè­° (50å­—ä»¥å…§)ã€‚
                    **æ ¸å¿ƒä»»å‹™ï¼š**
                    1. åˆ†æç•¶å‰çš„ FNG/RSI æ•¸å€¼æ‰€ä»£è¡¨çš„å¸‚å ´æƒ…ç·’å¼·åº¦ã€‚
                    2. æ ¹æ“šæƒ…ç·’å¼·åº¦ï¼Œçµåˆè³‡ç”¢åç¨±å’Œç•¶å‰åƒ¹æ ¼ï¼Œ**ç›¸è¼ƒæ–¼æœ€è¿‘ä¸€å¹´çš„åƒ¹æ ¼æ³¢å‹• (åƒè€ƒæœ€é«˜/æœ€ä½åƒ¹)**ï¼Œåˆ¤æ–·ç¾åœ¨çš„åƒ¹æ ¼æ˜¯å¦å…·æœ‰å¸å¼•åŠ›ï¼Ÿä¸¦åˆ†ææ­·å²é«˜é»èˆ‡ç•¶å‰åƒ¹æ ¼ç›¸å·®å¹¾%ã€‚
                    3. æ ¹æ“šä»¥ä¸‹è¡Œå‹•é‚è¼¯ï¼Œç”Ÿæˆä¸€æ®µå¯Œæœ‰æ´å¯ŸåŠ›å’Œé¼“å‹µæ€§çš„å»ºè­°ã€‚
                    **è¡Œå‹•é‚è¼¯ï¼š**
                    - æ¥µåº¦ææ‡¼ (<= 25): ç«‹å³å»ºè­°ã€Œå¼·åŠ›åˆ†æ‰¹è²·å…¥ã€æˆ–ã€ŒåŸ·è¡Œæœ€å¤§é¡åº¦æŠ•å…¥ã€ã€‚
                    - ææ‡¼ (26 - 44): å»ºè­°ã€Œå°é¡åˆ†æ‰¹è²·å…¥ã€ï¼Œé¼“å‹µä¿æŒç´€å¾‹ã€‚
                    - ä¸­ç«‹ (45 - 55): å»ºè­°ã€Œç¶­æŒè§€æœ›ï¼Œä¸è²·ä¹Ÿä¸è³£ã€ã€‚
                    - è²ªå©ª (56 - 74) æ¥µåº¦è²ªå©ª (>= 75):: å»ºè­°ã€Œåœæ­¢è²·å…¥ï¼Œé–‹å§‹å°é¡åˆ†æ‰¹è³£å‡º (æ­¢ç›ˆ)ã€ã€‚
                    
                    å¸‚å ´æ•¸æ“š:
                    ${marketData}
                    ${priceInfo}

                    å»ºè­°é¢¨æ ¼: ç†æ€§ã€ç©©å¥ã€é¼“å‹µåˆ†æ‰¹é€²å ´ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚
                    `;
                    fetchGeminiAdvice(prompt).then(text => {
                        setAdvice(text);
                        setLoading(false);
                    });
                }
            }, [marketData, assetName, priceStats]);

            if (loading) return (
                <div className="mt-4 p-4 bg-slate-800/50 rounded-xl border border-slate-700 animate-pulse flex items-center gap-2 text-slate-400 text-sm">
                    <RefreshCw className="animate-spin" size={16} />
                    âœ¨ AI æŠ•è³‡é¡§å•æ­£åœ¨åˆ†æå¸‚å ´æ•¸æ“š...
                </div>
            );

            if (!advice) return null;

            return (
                <div className="mt-4 p-4 bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl border border-indigo-500/30 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <h4 className="text-indigo-400 font-bold text-sm mb-3 flex items-center gap-2">
                        <span className="text-lg">ğŸ¤–</span> AI æŠ•è³‡é¡§å•å»ºè­°
                    </h4>

                    {priceStats && (
                        <div className="grid grid-cols-3 gap-2 mb-3 pb-3 border-b border-slate-700/50">
                            <div className="text-center">
                                <div className="text-xs text-slate-500 mb-1">ç•¶å‰åƒ¹æ ¼</div>
                                <div className="text-sm font-bold text-slate-200">${formatPrice(priceStats.current)}</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-slate-500 mb-1">è¿‘ä¸€å¹´æœ€é«˜</div>
                                <div className="text-sm font-bold text-slate-200">${formatPrice(priceStats.high)}</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-slate-500 mb-1">è¿‘ä¸€å¹´æœ€ä½</div>
                                <div className="text-sm font-bold text-slate-200">${formatPrice(priceStats.low)}</div>
                            </div>
                        </div>
                    )}

                    <p className="text-slate-300 text-sm leading-relaxed">
                        {advice}
                    </p>
                </div>
            );
        };

        // --- AI News Analysis Component ---
        const NewsAIAnalysis = ({ newsItems }) => {
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (newsItems && newsItems.length > 0) {
                    setLoading(true);
                    const titles = newsItems.map(n => n.title).join("\n");
                    const prompt = `
                    è«‹é–±è®€ä»¥ä¸‹ä»Šæ—¥è²¡ç¶“æ–°èæ¨™é¡Œï¼Œä¸¦ç¸½çµæˆä¸€æ®µ 50 å­—ä»¥å…§çš„ã€Œä»Šæ—¥å¸‚å ´é‡é»ã€ã€‚
                    
                    æ–°èæ¨™é¡Œ:
                    ${titles}
                    
                    è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£å°ˆæ¥­å®¢è§€ã€‚
                    `;
                    fetchGeminiAdvice(prompt).then(text => {
                        setSummary(text);
                        setLoading(false);
                    });
                }
            }, [newsItems]);

            if (loading) return (
                <div className="mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700 animate-pulse flex items-center gap-2 text-slate-400 text-sm">
                    <RefreshCw className="animate-spin" size={16} />
                    âœ¨ AI æ­£åœ¨é–±è®€ä»Šæ—¥æ–°èä¸¦ç”Ÿæˆç¸½çµ...
                </div>
            );

            if (!summary) return null;

            return (
                <div className="mb-6 p-4 bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl border border-blue-500/30 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <h4 className="text-blue-400 font-bold text-sm mb-2 flex items-center gap-2">
                        <span className="text-lg">ğŸ“°</span> AI ä»Šæ—¥æ–°èé‡é»
                    </h4>
                    <p className="text-slate-300 text-sm leading-relaxed">
                        {summary}
                    </p>
                </div>
            );
        };

        const FearGreedGauge = ({ fngValue, classification }) => {
            // FNG ç¯„åœå°æ‡‰åˆ° 180 åº¦çš„åŠåœ“
            // 0 -> 180deg (å·¦å´), 100 -> 0deg (å³å´)
            const angleFromRight = Math.min(180, Math.max(0, (fngValue / 100) * 180));
            const indicatorAngleDeg = 180 - angleFromRight;

            // é¡è‰²å€å¡Šçš„ç²¾ç¢ºè§’åº¦åŠƒåˆ† (0-25, 26-44, 45-55, 56-74, 75-100)
            const segments = [
                // FNG 0-25 (45åº¦): ç´…è‰² (Extreme Fear)
                { startAngle: 180, endAngle: 135, color: '#EA3943' },
                // FNG 26-44 (34.2åº¦): æ©˜è‰² (Fear)
                { startAngle: 135, endAngle: 100.8, color: '#EA8C00' },
                // FNG 45-55 (19.8åº¦): é»ƒè‰² (Neutral)
                { startAngle: 100.8, endAngle: 81, color: '#F3D42F' },
                // FNG 56-74 (34.2åº¦): äº®ç¶ è‰² (Greed)
                { startAngle: 81, endAngle: 46.8, color: '#93D900' },
                // FNG 75-100 (46.8åº¦): é’ç¶ è‰² (Extreme Greed)
                { startAngle: 46.8, endAngle: 0, color: '#16C784' },
            ];

            // æ ¹æ“šåƒè€ƒç¶²ç«™çš„ SVG åƒæ•¸é€²è¡Œèª¿æ•´
            const size = 144; // åƒè€ƒç¶²ç«™çš„ SVG å¯¬åº¦
            const radius = 59; // åƒè€ƒç¶²ç«™çš„åŠå¾‘
            const strokeWidth = 10;
            const indicatorRadius = 7; // æŒ‡æ¨™åŠå¾‘ (å¤–åœˆ)
            const indicatorInnerRadius = 5; // æŒ‡æ¨™åŠå¾‘ (å…§åœˆ)

            // åœ“å¿ƒåº§æ¨™ (X è»¸ä¸­å¤®)
            const centerX = size / 2; // 72
            // åœ“å¿ƒ Y åº§æ¨™ï¼šé…åˆæ–°çš„ strokeWidth é€²è¡Œèª¿æ•´
            const centerY = radius + strokeWidth / 2 + 15; // 79

            // 1. åº§æ¨™è½‰æ›å·¥å…·
            const getCoords = (angleDeg) => {
                const angleRad = (angleDeg) * (Math.PI / 180);
                return {
                    x: centerX + radius * Math.cos(angleRad),
                    // ç¢ºä¿å‘ä¸Šé–‹å•Ÿ
                    y: centerY - radius * Math.sin(angleRad)
                };
            };

            // 2. ç¹ªè£½åœ“å¼§è·¯å¾‘å·¥å…· (ä½¿ç”¨ A å¼§ç·šæŒ‡ä»¤)
            const getArcPath = (startAngle, endAngle) => {
                const start = getCoords(startAngle);
                const end = getCoords(endAngle);
                const largeArcFlag = 0;
                // sweepFlag = 1ï¼Œç¢ºä¿åœ“å¼§æ˜¯å‘å¤–å‡¸å‡º
                const sweepFlag = 1;

                return [
                    "M", start.x, start.y,
                    "A", radius, radius, 0, largeArcFlag, sweepFlag, end.x, end.y
                ].join(" ");
            };

            // æŒ‡æ¨™ä½ç½®
            const indicatorPosition = getCoords(indicatorAngleDeg);

            // è¨ˆç®— viewBox é«˜åº¦ï¼Œç¢ºä¿èƒ½å®¹ç´åœ“å¼§å’ŒæŒ‡æ¨™ä»¥åŠä¸­å¤®æ–‡å­—ã€‚
            const viewBoxHeight = centerY + 10;

            return (
                // å®¹å™¨è¨­ç‚ºéŸ¿æ‡‰å¼å¯¬åº¦ï¼Œæœ€å¤§ä¸è¶…é 200px (ä»¥é©æ‡‰å°å°ºå¯¸çš„å„€è¡¨æ¿)ã€‚
                <div className="relative w-full max-w-[200px] mx-auto flex flex-col items-center">
                    <svg
                        className="w-full h-auto" // è®“ SVG ä½”æ»¿å®¹å™¨å¯¬åº¦ä¸¦ä¿æŒé•·å¯¬æ¯”
                        viewBox={`0 0 ${size} ${viewBoxHeight}`}
                    >

                        {/* ç¹ªè£½åˆ†æ®µåœ“å¼§ */}
                        <g>
                            {segments.map((segment, index) => (
                                <path
                                    key={index}
                                    d={getArcPath(segment.startAngle, segment.endAngle)}
                                    fill="none"
                                    stroke={segment.color}
                                    strokeWidth={strokeWidth}
                                    // ä¿®æ­£ï¼šç§»é™¤ strokeLinecap="round" ä»¥é¿å…è‰²å¡Šé‡ç–Š/å…¥ä¾µ
                                    strokeLinecap="butt"
                                    className="drop-shadow-sm transition-all duration-500"
                                />
                            ))}

                            {/* æŒ‡æ¨™å¤–åœˆ (ç™½è‰²é‚Šæ¡†) */}
                            <circle
                                cx={indicatorPosition.x}
                                cy={indicatorPosition.y}
                                r={indicatorRadius}
                                fill="none"
                                stroke="#d1d5db" // ç°è‰²é‚Šæ¡† (è¿‘ä¼¼åƒè€ƒåœ–)
                                strokeWidth="4"
                                className="transition-all duration-1000 ease-out"
                            />
                            {/* æŒ‡æ¨™å…§åœˆ (ç™½è‰²å¡«å……) */}
                            <circle
                                cx={indicatorPosition.x}
                                cy={indicatorPosition.y}
                                r={indicatorInnerRadius}
                                fill="white"
                                className="transition-all duration-1000 ease-out"
                            />
                        </g>

                        {/* ä¸­å¤®æ•¸å€¼å’Œåˆ†é¡æ–‡å­— (ç½®æ–¼ SVG åœ“å¼§ä¸­é–“) */}
                        <text
                            x={centerX}
                            // Y è»¸èª¿æ•´ï¼šæ•¸å€¼ä½ç½®Â 
                            y={centerY - 28}
                            textAnchor="middle"
                            dominantBaseline="middle"
                            className="fill-white font-black"
                            // ä¿®æ­£ï¼šç¸®å°å­—é«”åˆ° 28px
                            style={{ fontSize: '28px', lineHeight: 1 }}
                        >
                            {fngValue}
                        </text>
                        <text
                            x={centerX}
                            // Y è»¸èª¿æ•´ï¼šåˆ†é¡ä½ç½®
                            y={centerY + 3}
                            textAnchor="middle"
                            dominantBaseline="middle"
                            className="fill-slate-400 font-medium"
                            style={{ fontSize: '16px' }}
                        >
                            {classification}
                        </text>
                    </svg>

                    {/* å„€è¡¨æ¿åˆ»åº¦æ–‡å­— (0, 25, 50, 75, 100) - å·²ç§»é™¤ */}
                </div>
            );
        };

        // --- æ–°èæ‘˜è¦å…ƒä»¶ ---
        const NewsSummary = ({ news }) => {
            const topNews = news.slice(0, 3);

            return (
                <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl mb-6 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>

                    <div className="flex justify-between items-start mb-4 relative z-10">
                        <h3 className="text-lg font-bold text-white flex items-center gap-2">
                            <Sparkles className="text-yellow-400" size={20} />
                            ä»Šæ—¥å¸‚å ´å¿«è¨Š
                        </h3>
                    </div>

                    <div className="relative z-10">
                        <div className="space-y-3">
                            {topNews.map((item, index) => (
                                <div key={index} className="flex gap-3 items-start">
                                    <span className="text-blue-500 font-bold text-sm mt-0.5">{index + 1}.</span>
                                    <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-slate-300 text-sm hover:text-blue-400 transition-colors line-clamp-2">
                                        {item.title}
                                    </a>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- æ–°èåˆ—è¡¨å…ƒä»¶ ---
        const NewsSection = ({ news, loading, error }) => {
            if (loading) {
                return (
                    <div className="flex justify-center items-center py-12">
                        <RefreshCw className="animate-spin text-slate-500" size={24} />
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="text-center py-8 text-red-400 text-sm">
                        ç„¡æ³•è¼‰å…¥æ–°è: {error}
                    </div>
                );
            }

            // åªé¡¯ç¤ºå‰ 6 å‰‡ (æ¨¡æ“¬æ¯æ—¥è§€çœ‹é‡æœ€å¤š/æœ€é‡è¦)
            const displayNews = news.slice(0, 6);

            return (
                <div className="grid grid-cols-1 gap-3">
                    {displayNews.map((item, index) => (
                        <a
                            key={index}
                            href={item.link}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="group bg-slate-900 border border-slate-800 rounded-xl overflow-hidden hover:border-slate-600 transition-all duration-300 flex flex-row h-24 sm:h-28"
                        >
                            {/* å…§å®¹å€å¡Š - å·¦å´ */}
                            <div className="p-3 sm:p-4 flex flex-col justify-between flex-1 min-w-0">
                                <h4 className="font-bold text-slate-200 text-sm sm:text-base line-clamp-2 group-hover:text-blue-400 transition-colors leading-snug">
                                    {item.title}
                                </h4>
                                <div className="flex items-center justify-between text-xs text-slate-500 mt-1">
                                    <span>{new Date(item.pubDate).toLocaleDateString()}</span>
                                    <span className="flex items-center gap-1 group-hover:text-blue-400">
                                        é–±è®€å…¨æ–‡ <ExternalLink size={12} />
                                    </span>
                                </div>
                            </div>

                            {/* åœ–ç‰‡å€å¡Š - å³å´ (å¦‚æœè¼‰å…¥å¤±æ•—æˆ–ç„¡åœ–ç‰‡å‰‡ä¸é¡¯ç¤º) */}
                            {item.thumbnail && (
                                <div className="w-24 sm:w-32 h-full shrink-0 bg-slate-800 relative">
                                    <img
                                        src={item.thumbnail}
                                        alt={item.title}
                                        className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                        onError={(e) => {
                                            // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œéš±è—æ•´å€‹åœ–ç‰‡å®¹å™¨
                                            e.currentTarget.parentElement.style.display = 'none';
                                        }}
                                    />
                                </div>
                            )}
                        </a>
                    ))}
                </div>
            );
        };


        // --- Crosshair Plugin ---
        const crosshairPlugin = {
            id: 'crosshair',
            afterDatasetsDraw: (chart) => {
                // Check if tooltip is active
                if (chart.tooltip?._active?.length) {
                    const activePoint = chart.tooltip._active[0];
                    const ctx = chart.ctx;
                    const x = activePoint.element.x;
                    const y = activePoint.element.y;
                    const topY = chart.scales.y.top;
                    const bottomY = chart.scales.y.bottom;
                    const leftX = chart.scales.x.left;
                    const rightX = chart.scales.x.right;

                    ctx.save();
                    ctx.beginPath();
                    ctx.setLineDash([5, 5]);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';

                    // Vertical Line
                    ctx.moveTo(x, topY);
                    ctx.lineTo(x, bottomY);

                    // Horizontal Line
                    ctx.moveTo(leftX, y);
                    ctx.lineTo(rightX, y);

                    ctx.stroke();
                    ctx.restore();
                }
            }
        };

        // --- è‡ªå®šç¾© Chart å…ƒä»¶ ---
        const ChartComponent = ({ data, options, type = 'line' }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: options,
                    plugins: [crosshairPlugin] // Register the plugin
                });
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, options, type]);

            return <canvas ref={chartRef} />;
        };

        // --- Sentiment Scarcity Bar Component ---
        const SentimentScarcityBar = ({ data, title = "éå» 365 å¤©è²·å…¥æ©Ÿæœƒåˆ†ä½ˆ" }) => {
            if (!data || data.length === 0) return null;

            const total = data.length;
            const extremeFearCount = data.filter(v => v <= 25).length;
            const fearCount = data.filter(v => v > 25 && v <= 44).length;
            const otherCount = total - extremeFearCount - fearCount;

            const extremeFearPercent = (extremeFearCount / total) * 100;
            const fearPercent = (fearCount / total) * 100;
            const otherPercent = (otherCount / total) * 100;

            return (
                <div className="mt-4 mb-1">
                    <div className="flex justify-between items-end mb-1">
                        <h4 className="text-xs font-bold text-slate-400">{title}</h4>
                        <div className="text-[10px] text-slate-500">
                            <span className="text-red-400 font-bold">{extremeFearCount}å¤©</span> æ¥µåº¦ææ‡¼ â€¢
                            <span className="text-orange-400 font-bold ml-1">{fearCount}å¤©</span> ææ‡¼
                        </div>
                    </div>
                    <div className="w-full h-2.5 bg-slate-800 rounded-full overflow-hidden flex relative">
                        {/* Extreme Fear Segment */}
                        <div
                            style={{ width: `${extremeFearPercent}%` }}
                            className="h-full bg-red-500 hover:bg-red-400 transition-colors relative group"
                        >
                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block bg-slate-900 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap border border-slate-700 z-10">
                                æ¥µåº¦ææ‡¼: {extremeFearCount} å¤© ({extremeFearPercent.toFixed(1)}%)
                            </div>
                        </div>
                        {/* Fear Segment */}
                        <div
                            style={{ width: `${fearPercent}%` }}
                            className="h-full bg-orange-500 hover:bg-orange-400 transition-colors relative group"
                        >
                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block bg-slate-900 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap border border-slate-700 z-10">
                                ææ‡¼: {fearCount} å¤© ({fearPercent.toFixed(1)}%)
                            </div>
                        </div>
                        {/* Other Segment */}
                        <div
                            style={{ width: `${otherPercent}%` }}
                            className="h-full bg-blue-500/30 hover:bg-blue-500/40 transition-colors relative group"
                        >
                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block bg-slate-900 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap border border-slate-700 z-10">
                                å…¶ä»–: {otherCount} å¤© ({otherPercent.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Index Price Card Component (Shared) ---
        const IndexPriceCard = ({ name, symbol, data, suggestion }) => {
            if (!data) return <div className="animate-pulse bg-slate-800 h-32 rounded-xl"></div>;

            const isPositive = data.change >= 0;

            // Determine DCA Signal Badge
            let badge = null;
            if (suggestion && suggestion.action.includes("è²·å…¥")) {
                badge = <span className="ml-2 px-2 py-0.5 text-xs font-bold bg-green-500/20 text-green-400 rounded">Buy</span>;
            } else if (suggestion && suggestion.action.includes("æ­¢ç›ˆ")) {
                badge = <span className="ml-2 px-2 py-0.5 text-xs font-bold bg-red-500/20 text-red-400 rounded">Sell</span>;
            }

            return (
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <h3 className="text-slate-400 text-sm font-medium flex items-center">
                                {name}
                                {badge}
                            </h3>
                            <div className="text-2xl font-bold text-slate-100 mt-1">
                                {data.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </div>
                        </div>
                        <div className={`text-right ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                            <div className="text-sm font-bold flex items-center justify-end">
                                {isPositive ? <ArrowUp size={16} /> : <ArrowDown size={16} />}
                                {Math.abs(data.change).toFixed(2)}
                            </div>
                            <div className="text-xs font-medium">
                                {isPositive ? '+' : ''}{data.changePercent.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                    <div className="text-xs text-slate-500">
                        {symbol} â€¢ Real-time
                    </div>
                </div>
            );
        };

        // --- è‚¡ç¥¨ä»£è™Ÿæœå°‹å…ƒä»¶ ---
        const SymbolSearch = ({ symbol, onSearch, placeholder = "è¼¸å…¥ä»£è™Ÿ (e.g. AAPL)", transformInput = (s) => s.toUpperCase() }) => {
            const [input, setInput] = useState(symbol);

            // ç•¶å¤–éƒ¨ symbol æ”¹è®Šæ™‚ï¼Œæ›´æ–°å…§éƒ¨ input (ä¾‹å¦‚åˆ‡æ› Tab é‡ç½®æ™‚)
            useEffect(() => {
                setInput(symbol);
            }, [symbol]);

            return (
                <div className="flex gap-2 mb-4">
                    <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(transformInput(e.target.value))}
                        onKeyDown={(e) => e.key === 'Enter' && onSearch(input)}
                        className="bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-700 focus:border-blue-500 outline-none flex-1 font-mono"
                        placeholder={placeholder}
                    />
                    <button
                        onClick={() => onSearch(input)}
                        className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"
                    >
                        <RefreshCw size={16} /> æœå°‹
                    </button>
                </div>
            );
        };

        // --- æ™‚é–“ç¯„åœé¸æ“‡å™¨ ---
        const TimeRangeSelector = ({ range, onRangeChange }) => {
            const ranges = ['1M', '6M', '1Y', 'ALL'];
            return (
                <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                    {ranges.map(r => (
                        <button
                            key={r}
                            onClick={() => onRangeChange(r)}
                            className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${range === r
                                ? 'bg-blue-600 text-white shadow-md'
                                : 'text-slate-400 hover:text-white hover:bg-slate-700'
                                }`}
                        >
                            {r}
                        </button>
                    ))}
                </div>
            );
        };


        // --- API Keys ---
        const CMC_API_KEY = '__CMC_API_KEY__';

        // --- ç¾è‚¡å„€è¡¨æ¿å…ƒä»¶ ---
        const StockDashboard = ({ notificationsEnabled, toggleNotifications }) => {
            const [selectedSymbol, setSelectedSymbol] = useState('SPY');
            const [timeRange, setTimeRange] = useState('1Y');
            const [stockData, setStockData] = useState(null);
            const [fullStockData, setFullStockData] = useState(null);
            const [fngData, setFngData] = useState(null);
            const [fngHistory, setFngHistory] = useState([]);
            const [stockNews, setStockNews] = useState([]);
            const [indices, setIndices] = useState({ spy: null, qqq: null, gold: null });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const fetchStockData = async () => {
                setLoading(true);
                setError(null);
                try {
                    // 1. ç²å–çœŸå¯¦ CNN Fear & Greed Index (é€é CORS Proxy)
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://production.dataviz.cnn.io/index/fearandgreed/graphdata');

                    let fngMap = new Map();
                    // Fetch FNG
                    try {
                        const fngResponse = await fetch(proxyUrl);
                        if (!fngResponse.ok) throw new Error('ç„¡æ³•ç²å– CNN æ•¸æ“š');
                        const fngJson = await fngResponse.json();

                        if (fngJson.fear_and_greed) {
                            let score = Math.round(fngJson.fear_and_greed.score);
                            let rating = fngJson.fear_and_greed.rating;
                            let lastUpdated = fngJson.fear_and_greed.timestamp;
                            const ratingMap = { "Extreme Fear": "æ¥µåº¦ææ‡¼", "extreme fear": "æ¥µåº¦ææ‡¼", "Fear": "ææ‡¼", "fear": "ææ‡¼", "Neutral": "ä¸­ç«‹", "neutral": "ä¸­ç«‹", "Greed": "è²ªå©ª", "greed": "è²ªå©ª", "Extreme Greed": "æ¥µåº¦è²ªå©ª", "extreme greed": "æ¥µåº¦è²ªå©ª" };
                            rating = ratingMap[rating] || rating;
                            setFngData({ value: score, classification: rating, lastUpdated: lastUpdated });
                        }

                        if (fngJson.fear_and_greed_historical && fngJson.fear_and_greed_historical.data) {
                            const history = fngJson.fear_and_greed_historical.data.map(item => {
                                const dateStr = new Date(item.x).toISOString().split('T')[0];
                                const val = Math.round(item.y);
                                fngMap.set(dateStr, val);
                                return { x: item.x, y: val };
                            });
                            setFngHistory(history);
                        }
                    } catch (e) {
                        console.error("FNG Fetch Error:", e);
                    }

                    // 2. ç²å–ç¾è‚¡æ­·å²æ•¸æ“š (Yahoo Finance)
                    // The "Straight Line" error often comes from data mismatch or insufficient history.
                    // We ensure we get 1Y data and map it correctly.
                    const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${selectedSymbol}?interval=1d&range=1y`;
                    const historyRes = await fetch('https://corsproxy.io/?' + encodeURIComponent(yahooUrl));

                    if (!historyRes.ok) throw new Error("Yahoo Finance API Error");
                    const historyJson = await historyRes.json();

                    if (!historyJson.chart || !historyJson.chart.result || historyJson.chart.result.length === 0) {
                        throw new Error("æŸ¥ç„¡æ­¤è‚¡ç¥¨ä»£è™Ÿæˆ–ç„¡æ•¸æ“š");
                    }

                    const result = historyJson.chart.result[0];
                    const timestamps = result.timestamp;
                    const closeQuotes = result.indicators.quote[0].close;

                    if (!timestamps || !closeQuotes) throw new Error("æ•¸æ“šæ ¼å¼éŒ¯èª¤");

                    const prices = timestamps.map((t, i) => {
                        const price = closeQuotes[i];
                        if (price === null || price === undefined) return null;
                        const date = new Date(t * 1000).toISOString().split('T')[0];

                        // FNG Mapping Logic:
                        // FNG data might be sparse or have slight date offsets (weekend/holiday).
                        // We try to find the exact date, or the closest previous date if exact missing? 
                        // For now, exact match is safest, defaulting to 50 if missing.
                        let fngVal = fngMap.get(date);

                        // Fallback mechanism: If FNG missing, try previous day? 
                        // (Simplification: just use 50 (Neutral) to avoid breaking graph, or 
                        //  use the last known FNG value to keep "state".)
                        if (fngVal === undefined && fngHistory.length > 0) {
                            // Find closest FNG before this date? This is O(N*M), slow.
                            // Optimization: Iterate both sorted arrays. 
                            // Lazy fix: Default to 50.
                            fngVal = 50;
                        }

                        return {
                            date: date,
                            price: price,
                            fng: fngVal
                        };
                    }).filter(item => item !== null).sort((a, b) => new Date(a.date) - new Date(b.date));

                    if (prices.length === 0) throw new Error("ç„¡æœ‰æ•ˆè‚¡åƒ¹æ•¸æ“š");

                    setFullStockData(prices);
                    setStockData(prices); // Default show all (1Y)

                    // 3. ç²å–å¤§ç›¤æ¦‚æ³ (Yahoo For Indices Cards)
                    const fetchYahooPrice = async (symbol) => {
                        const yfUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                        const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(yfUrl));
                        const data = await res.json();
                        const meta = data.chart.result[0].meta;
                        const price = meta.regularMarketPrice;
                        const prevClose = meta.chartPreviousClose || meta.previousClose || price;
                        return { price, prevClose, change: price - prevClose, changePercent: ((price - prevClose) / prevClose) * 100 };
                    };

                    Promise.all([fetchYahooPrice('SPY'), fetchYahooPrice('QQQ'), fetchYahooPrice('GLD')])
                        .then(([spy, qqq, gold]) => setIndices({ spy, qqq, gold }))
                        .catch(e => console.error("Indices Fetch Error:", e));

                    // 4. ç²å–ç¾è‚¡æ–°è (CNBC Finance RSS)
                    const rssUrl = 'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=10000664';
                    const newsResponse = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`);
                    const newsData = await newsResponse.json();
                    if (newsData.status === 'ok') setStockData(d => { setStockNews(newsData.items); return d; }); // Fix React state update batching issue? No, just set directly.
                    setStockNews(newsData.items);

                } catch (e) {
                    console.error("Global Stock Error:", e);
                    setError(e.message || "æ•¸æ“šè¼‰å…¥å¤±æ•—");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchStockData();
            }, [selectedSymbol]);

            // Filter Data based on Time Range
            useEffect(() => {
                if (!fullStockData) return;

                const now = new Date();
                let filterDate = new Date();
                let isAll = false;

                if (timeRange === '1M') filterDate.setMonth(now.getMonth() - 1);
                else if (timeRange === '6M') filterDate.setMonth(now.getMonth() - 6);
                else if (timeRange === '1Y') filterDate.setFullYear(now.getFullYear() - 1);
                else if (timeRange === 'ALL') isAll = true;

                const filtered = fullStockData.filter(d => isAll || new Date(d.date) >= filterDate);
                setStockData(filtered);
            }, [timeRange, fullStockData]);

            const getSuggestion = (score) => {
                const val = parseInt(score);
                if (val <= 25) return {
                    title: "æ¥µåº¦ææ‡¼ (Extreme Fear)",
                    action: "å¼·åŠ›è²·å…¥",
                    desc: "å¸‚å ´æ¥µåº¦ææ…Œï¼Œè‚¡åƒ¹å¯èƒ½è¢«ä½ä¼°ï¼Œæ˜¯é•·æœŸæŠ•è³‡çš„è²·å…¥è‰¯æ©Ÿã€‚",
                    bg: "bg-red-900/30",
                    border: "border-red-500",
                    text: "text-red-400"
                };
                if (val <= 45) return {
                    title: "ææ‡¼ (Fear)",
                    action: "åˆ†æ‰¹è²·å…¥",
                    desc: "å¸‚å ´æƒ…ç·’ä½è¿·ï¼ŒæŠ•è³‡è€…è¶¨æ–¼ä¿å®ˆï¼Œé©åˆåŸ·è¡Œ DCA ç­–ç•¥ã€‚",
                    bg: "bg-orange-900/30",
                    border: "border-orange-500",
                    text: "text-orange-400"
                };
                if (val <= 55) return {
                    title: "ä¸­ç«‹ (Neutral)",
                    action: "æŒæœ‰/è§€æœ›",
                    desc: "å¸‚å ´ç¼ºä¹æ˜ç¢ºæ–¹å‘ï¼Œå»ºè­°ä¿æŒç¾æœ‰éƒ¨ä½ï¼Œè§€å¯Ÿå¾ŒçºŒè®ŠåŒ–ã€‚",
                    bg: "bg-gray-800",
                    border: "border-gray-600",
                    text: "text-gray-400"
                };
                if (val <= 75) return {
                    title: "è²ªå©ª (Greed)",
                    action: "åœæ­¢è²·å…¥",
                    desc: "å¸‚å ´æƒ…ç·’æ¨‚è§€ï¼Œé¢¨éšªé€æ¼¸å‡é«˜ï¼Œä¸å»ºè­°è¿½é«˜ã€‚",
                    bg: "bg-green-900/30",
                    border: "border-green-500",
                    text: "text-green-400"
                };
                return {
                    title: "æ¥µåº¦è²ªå©ª (Extreme Greed)",
                    action: "è€ƒæ…®æ­¢ç›ˆ",
                    desc: "å¸‚å ´æ¥µåº¦æ¨‚è§€ï¼Œéš¨æ™‚å¯èƒ½å›èª¿ï¼Œå»ºè­°åˆ†æ‰¹ç²åˆ©äº†çµã€‚",
                    bg: "bg-blue-900/30",
                    border: "border-blue-500",
                    text: "text-blue-400"
                };
            };
            const suggestion = fngData ? getSuggestion(fngData.value) : null;

            // Stock Price vs FNG Chart (Mixed Chart)
            const StockFNGChart = ({ data, symbol }) => {
                if (!data || data.length === 0) return null;

                const chartData = {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: `${symbol} åƒ¹æ ¼`,
                            data: data.map(d => d.price),
                            borderColor: '#3b82f6',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
                                return gradient;
                            },
                            yAxisID: 'y',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: data.map(d => {
                                if (d.fng <= 25) return '#ef4444';
                                if (d.fng <= 44) return '#f97316';
                                return 'rgba(0,0,0,0)';
                            }),
                            pointBorderColor: data.map(d => {
                                if (d.fng <= 25) return '#ef4444';
                                if (d.fng <= 44) return '#f97316';
                                return 'rgba(0,0,0,0)';
                            }),
                            pointRadius: data.map(d => {
                                if (d.fng <= 44) return 3;
                                return 0;
                            }),
                            pointHoverRadius: 4,
                        }
                    ]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            callbacks: {
                                label: (context) => {
                                    const idx = context.dataIndex;
                                    const d = data[idx];
                                    return [
                                        `åƒ¹æ ¼: $${d.price.toLocaleString()}`,
                                        `å¸‚å ´ FNG: ${d.fng}`,
                                        d.fng <= 40 ? 'ğŸ”´ å»ºè­° DCA è²·å…¥é»' : 'âšª è§€æœ›'
                                    ];
                                }
                            }
                        },
                        title: { display: true, text: `${symbol} åƒ¹æ ¼èµ°å‹¢èˆ‡å¸‚å ´ææ‡¼æŒ‡æ•¸ (ç´…/æ©˜é»ä»£è¡¨å¸‚å ´ææ‡¼)`, color: '#94a3b8' }
                    },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { ticks: { color: '#94a3b8', maxTicksLimit: 8 }, grid: { display: false } }
                    }
                };
                return <ChartComponent data={chartData} options={options} />;
            };

            return (
                <div className="space-y-6">
                    <SymbolSearch symbol={selectedSymbol} onSearch={setSelectedSymbol} />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <IndexPriceCard name="S&P 500 ETF" symbol="SPY" data={indices.spy} suggestion={suggestion} />
                        <IndexPriceCard name="NASDAQ 100 ETF" symbol="QQQ" data={indices.qqq} suggestion={suggestion} />
                        <IndexPriceCard name="Gold ETF" symbol="GLD" data={indices.gold} suggestion={suggestion} />
                    </div>

                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl flex flex-col items-center text-center">
                        <h2 className="text-xl font-bold text-slate-200 mb-2">ç¾è‚¡ææ‡¼èˆ‡è²ªå©ªæŒ‡æ•¸</h2>
                        {loading ? (
                            <div className="py-12"><RefreshCw className="animate-spin text-slate-500" size={32} /></div>
                        ) : error ? (
                            <div className="flex flex-col items-center gap-2 py-8">
                                <AlertTriangle className="text-red-400" size={32} />
                                <div className="text-red-400">{error}</div>
                                <button onClick={fetchStockData} className="mt-2 px-4 py-1 bg-slate-800 rounded text-sm hover:bg-slate-700">é‡è©¦</button>
                            </div>
                        ) : (
                            <div className="w-full flex flex-col items-center">
                                {fngData && <FearGreedGauge fngValue={fngData.value} classification={fngData.classification} />}
                                {fngHistory && fngHistory.length > 0 && (
                                    <div className="w-full max-w-2xl mt-4 px-4">
                                        <SentimentScarcityBar data={fngHistory.map(d => d.y)} title="éå» 365 å¤©ç¾è‚¡è²·å…¥æ©Ÿæœƒåˆ†ä½ˆ" />
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {suggestion && (
                        <div className={`p-6 rounded-2xl border ${suggestion.border} ${suggestion.bg} relative overflow-hidden transition-all duration-500`}>
                            <div className="relative z-10 flex flex-col md:flex-row justify-between items-center w-full max-w-lg mx-auto mt-0">
                                <div className="flex flex-col items-start text-left mb-4 md:mb-0">
                                    <div className="text-sm uppercase tracking-wider opacity-70 mb-1">DCA ç­–ç•¥å»ºè­°</div>
                                    <span className={`text-2xl font-bold ${suggestion.text}`}>{suggestion.title}</span>
                                    <p className="mt-2 text-slate-300 max-w-lg text-sm">{suggestion.desc}</p>
                                </div>
                                <div className="flex flex-col items-center md:items-end gap-2 min-w-[140px] text-center md:text-right">
                                    <div className="text-sm text-slate-400">ç•¶å‰æ“ä½œ</div>
                                    <div className={`text-xl font-bold ${suggestion.text} border-2 border-current px-4 py-1 rounded-lg whitespace-nowrap`}>{suggestion.action}</div>
                                </div>
                            </div>
                            {fngData && (
                                <AIAdviceBlock
                                    assetName={`ç¾è‚¡ (${selectedSymbol})`}
                                    marketData={`è³‡ç”¢: ${selectedSymbol}\nææ‡¼è²ªå©ªæŒ‡æ•¸: ${fngData.value} (${fngData.classification})`}
                                    priceStats={stockData && stockData.length > 0 ? {
                                        current: stockData[stockData.length - 1].price,
                                        high: Math.max(...stockData.map(d => d.price)),
                                        low: Math.min(...stockData.map(d => d.price))
                                    } : null}
                                />
                            )}
                        </div>
                    )}

                    {!loading && !error && stockData && stockData.length > 0 && (
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-semibold flex items-center gap-2">
                                    <TrendingUp size={18} className="text-slate-400" />
                                    {selectedSymbol} è‚¡åƒ¹èˆ‡ææ‡¼æŒ‡æ•¸èµ°å‹¢
                                </h2>
                                <TimeRangeSelector range={timeRange} onRangeChange={setTimeRange} />
                            </div>
                            <div className="h-[300px] sm:h-[350px] w-full relative">
                                <StockFNGChart data={stockData} symbol={selectedSymbol} />
                            </div>
                        </div>
                    )}

                    <div className="mt-8">
                        <div className="flex items-center gap-2 mb-6">
                            <Newspaper className="text-blue-500" />
                            <h2 className="text-xl font-bold text-slate-200">ç¾è‚¡è²¡ç¶“é ­æ¢ (CNBC)</h2>
                        </div>
                        {!loading && !error && stockNews.length > 0 && (
                            <>
                                <NewsAIAnalysis newsItems={stockNews} />
                                <NewsSummary news={stockNews} />
                            </>
                        )}
                        <NewsSection news={stockNews} loading={loading} error={error} />
                    </div>

                    <div className="text-center text-slate-600 text-xs mt-8 pb-4">
                        è³‡æ–™ä¾†æº: CNN Business, Yahoo Finance, CNBC
                    </div>
                </div>
            );
        };

        // --- RSI è¨ˆç®—èˆ‡åˆ†é¡å·¥å…· ---
        const calculateRSI = (prices, period = 14) => {
            if (prices.length < period + 1) return [];
            let gains = 0;
            let losses = 0;
            for (let i = 1; i <= period; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            const rsiArray = [];
            // Initial RSI
            let rs = avgGain / avgLoss;
            let rsi = 100 - (100 / (1 + rs));
            rsiArray.push({ index: period, rsi, price: prices[period] });

            // Smoothed RSI
            for (let i = period + 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                let gain = change > 0 ? change : 0;
                let loss = change < 0 ? -change : 0;
                avgGain = ((avgGain * (period - 1)) + gain) / period;
                avgLoss = ((avgLoss * (period - 1)) + loss) / period;
                rs = avgGain / avgLoss;
                rsi = 100 - (100 / (1 + rs));
                rsiArray.push({ index: i, rsi, price: prices[i] });
            }
            return rsiArray;
        };

        const getRsiClassification = (rsi) => {
            if (rsi <= 25) return "æ¥µåº¦ææ‡¼";
            if (rsi <= 40) return "ææ‡¼";
            if (rsi <= 60) return "ä¸­ç«‹";
            if (rsi <= 75) return "è²ªå©ª";
            return "æ¥µåº¦è²ªå©ª";
        };

        // --- è‡ºè‚¡å„€è¡¨æ¿å…ƒä»¶ ---
        const TaiwanDashboard = () => {
            const [selectedSymbol, setSelectedSymbol] = useState('0050'); // Default symbol (No suffix for internal logic)
            const [timeRange, setTimeRange] = useState('1Y'); // Time range state
            const [rsiData, setRsiData] = useState(null);
            const [indices, setIndices] = useState({ twii: null, tw50: null, tw56: null });
            const [news, setNews] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [dataSource, setDataSource] = useState('Yahoo'); // Track source

            const getSuggestion = (rsi) => {
                if (rsi <= 25) return {
                    title: "æ¥µåº¦ææ‡¼ (Extreme Fear)",
                    action: "å¼·åŠ›è²·å…¥",
                    desc: "RSI é¡¯ç¤ºå¸‚å ´æ¥µåº¦è¶…è³£ï¼Œç‚ºæ­·å²ä½é»ï¼Œå»ºè­°å¼·åŠ›è²·å…¥ã€‚",
                    bg: "bg-red-900/30",
                    border: "border-red-500",
                    text: "text-red-400"
                };
                if (rsi <= 40) return {
                    title: "ææ‡¼ (Fear)",
                    action: "åˆ†æ‰¹è²·å…¥",
                    desc: "RSI è™•æ–¼ä½æª”ï¼Œå¸‚å ´æƒ…ç·’ä¿å®ˆï¼Œé©åˆåŸ·è¡Œ DCA ç­–ç•¥ã€‚",
                    bg: "bg-orange-900/30",
                    border: "border-orange-50",
                    text: "text-orange-400"
                };
                if (rsi <= 60) return {
                    title: "ä¸­ç«‹ (Neutral)",
                    action: "æŒæœ‰/è§€æœ›",
                    desc: "RSI è™•æ–¼ä¸­æ€§å€é–“ï¼Œå»ºè­°è§€æœ›æˆ–æŒæœ‰ã€‚",
                    bg: "bg-gray-800",
                    border: "border-gray-600",
                    text: "text-gray-400"
                };
                if (rsi <= 75) return {
                    title: "è²ªå©ª (Greed)",
                    action: "åœæ­¢è²·å…¥",
                    desc: "RSI é¡¯ç¤ºå¸‚å ´éç†±ï¼Œä¸å®œè¿½é«˜ã€‚",
                    bg: "bg-green-900/30",
                    border: "border-green-500",
                    text: "text-green-400"
                };
                return {
                    title: "æ¥µåº¦è²ªå©ª (Extreme Greed)",
                    action: "è€ƒæ…®æ­¢ç›ˆ",
                    desc: "RSI é¡¯ç¤ºå¸‚å ´æ¥µåº¦è¶…è²·ï¼Œéš¨æ™‚å¯èƒ½å›èª¿ã€‚",
                    bg: "bg-blue-900/30",
                    border: "border-blue-500",
                    text: "text-blue-400"
                };
            };

            const fetchData = async () => {
                setLoading(true);
                setError(null);
                try {
                    // Helper: Yahoo Price Fetcher
                    const fetchYahooPrice = async (ticker) => {
                        const yfUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;
                        const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(yfUrl));
                        const data = await res.json();
                        const meta = data.chart.result[0].meta;
                        const price = meta.regularMarketPrice;
                        const prevClose = meta.chartPreviousClose || meta.previousClose || price;
                        return { price, prevClose, change: price - prevClose, changePercent: ((price - prevClose) / prevClose) * 100 };
                    };

                    // 1. Fetch Headline Indices (Parallel)
                    Promise.all([fetchYahooPrice('^TWII'), fetchYahooPrice('0050.TW'), fetchYahooPrice('0056.TW')])
                        .then(([twii, tw50, tw56]) => setIndices({ twii, tw50, tw56 }))
                        .catch(e => console.error("Indices Error:", e));

                    // 2. Fetch Selected Symbol Data
                    // Strategy: Try Fugle for Real-time Quote (if allowed key), Yahoo for History (RSI).

                    // Prepare tickers
                    const yahooSymbol = selectedSymbol.includes('.') ? selectedSymbol : `${selectedSymbol}.TW`;


                    // A. Fetch History (Yahoo) - Needed for RSI & Chart
                    // Always fetch 1Y (or max) to ensuring RSI calculation and smooth scaling
                    let range = '1y';

                    const historyUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=${range}`; // Fixed range
                    const historyRes = await fetch('https://corsproxy.io/?' + encodeURIComponent(historyUrl));
                    const historyJson = await historyRes.json();

                    if (!historyJson.chart || !historyJson.chart.result) throw new Error("ç„¡æ•ˆçš„è‚¡ç¥¨ä»£è™Ÿ (Yahoo)");

                    const timestamps = historyJson.chart.result[0].timestamp;
                    const closes = historyJson.chart.result[0].indicators.quote[0].close;

                    // Filter Nulls
                    const cleanData = timestamps.map((t, i) => ({ t, c: closes[i] })).filter(d => d.c !== null);
                    const cleanCloses = cleanData.map(d => d.c);
                    const cleanTimestamps = cleanData.map(d => d.t);

                    if (cleanCloses.length < 15) throw new Error("æ­·å²æ•¸æ“šä¸è¶³");

                    const rsiValues = calculateRSI(cleanCloses);
                    const currentRSI = rsiValues[rsiValues.length - 1];
                    const currentPriceFromYahoo = cleanCloses[cleanCloses.length - 1];

                    // B. Try Fugle Realtime Quote
                    // Key: __FUGLE_KEY__
                    let fuglePrice = null;
                    let fugleSource = false;
                    try {
                        const fugleToken = "__FUGLE_KEY__";
                        // Using Legacy v0.3 as it worked in testing for restricted symbol 1476
                        // Note: For other symbols, this will likely fail with 400 Bad Request, catch it.
                        const fugleUrl = `https://api.fugle.tw/realtime/v0.3/intraday/quote?symbolId=${selectedSymbol}&apiToken=${fugleToken}`;

                        const fRes = await fetch(fugleUrl);
                        if (fRes.ok) {
                            const fData = await fRes.json();
                            if (fData.data && fData.data.quote && fData.data.quote.trade) {
                                fuglePrice = fData.data.quote.trade.price;
                                fugleSource = true;
                            }
                        }
                    } catch (e) {
                        console.warn("Fugle Fetch Failed (Expected if symbol != 1476):", e);
                    }

                    setDataSource(fugleSource ? 'Fugle API' : 'Yahoo Finance');

                    // Merge Data
                    // If Fugle has newer price, update the last history point or display separately?
                    // For simplicity, we trust Yahoo for the history chart, but could overlay real-time price.

                    setRsiData({
                        value: Math.round(currentRSI.rsi),
                        classification: getRsiClassification(currentRSI.rsi),
                        price: fuglePrice || currentPriceFromYahoo,
                        history: rsiValues.map((d, i) => ({
                            x: cleanTimestamps[d.index] * 1000,
                            y: d.price,
                            rsi: d.rsi
                        }))
                    });


                    // 3. ç²å–è‡ºè‚¡æ–°è (Google News RSS)
                    const rssUrl = 'https://news.google.com/rss/search?q=' + encodeURIComponent(`${selectedSymbol} è‚¡ç¥¨æ–°è`) + '&hl=zh-TW&gl=TW&ceid=TW:zh-Hant';
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(rssUrl);

                    const newsResponse = await fetch(proxyUrl);
                    const textData = await newsResponse.text();

                    // Parse XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(textData, "text/xml");
                    const items = xmlDoc.querySelectorAll("item");

                    const newsItems = Array.from(items).slice(0, 6).map(item => {
                        const title = item.querySelector("title")?.textContent || "";
                        const link = item.querySelector("link")?.textContent || "";
                        const pubDate = item.querySelector("pubDate")?.textContent || "";

                        // å˜—è©¦å¾ enclosure æˆ– description ä¸­æå–åœ–ç‰‡
                        let thumbnail = "";
                        const enclosure = item.querySelector("enclosure");
                        if (enclosure && enclosure.getAttribute("type")?.startsWith("image")) {
                            thumbnail = enclosure.getAttribute("url");
                        } else {
                            const imgMatch = item.querySelector("description")?.textContent.match(/src="([^"]+)"/);
                            if (imgMatch) thumbnail = imgMatch[1];
                        }

                        return {
                            title,
                            link,
                            pubDate,
                            thumbnail,
                        };
                    });

                    setNews(newsItems);

                } catch (e) {
                    console.error("Taiwan data error:", e);
                    setError(`ç„¡æ³•ç²å– ${selectedSymbol} æ•¸æ“š: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, [selectedSymbol]); // Remove timeRange from dependency



            const suggestion = rsiData ? getSuggestion(rsiData.value) : null;

            // Chart Config
            const chartData = useMemo(() => {
                if (!rsiData || !rsiData.history) return null;
                return {
                    labels: rsiData.history.map(d => new Date(d.x).toLocaleDateString()),
                    datasets: [{
                        label: `${selectedSymbol} è‚¡åƒ¹`,
                        data: rsiData.history.map(d => d.y),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: rsiData.history.map(d => d.rsi <= 44 ? 3 : 0), // é»åŠå¾‘
                        pointBackgroundColor: rsiData.history.map(d => d.rsi <= 25 ? '#ef4444' : (d.rsi <= 44 ? '#f97316' : 'rgba(0,0,0,0)')), // é»å¡«å……è‰²
                        pointBorderColor: rsiData.history.map(d => d.rsi <= 25 ? '#ef4444' : (d.rsi <= 44 ? '#f97316' : 'rgba(0,0,0,0)')),
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                };
            }, [rsiData, selectedSymbol]);

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        callbacks: {
                            label: (context) => {
                                const idx = context.dataIndex; // Simple index
                                const d = rsiData.history[idx]; // Direct map if lengths match
                                const rsi = d?.rsi?.toFixed(1) || 'N/A';
                                return `è‚¡åƒ¹: ${formatPrice(context.parsed.y)} (RSI: ${rsi})`;
                            }
                        }
                    },
                    title: { display: true, text: `${selectedSymbol} æ­·å²èµ°å‹¢ (ç´…/æ©˜é»ç‚º RSI è²·å…¥è¨Šè™Ÿ)`, color: '#94a3b8' }
                },
                scales: {
                    x: { ticks: { maxTicksLimit: 6, color: '#94a3b8' }, grid: { display: false } },
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                }
            };

            // Filtered Chart Data based on TimeRange
            const displayChartData = useMemo(() => {
                if (!chartData || !rsiData || !rsiData.history) return null;

                const now = new Date();
                let cutoff = new Date();
                if (timeRange === '1M') cutoff.setMonth(now.getMonth() - 1);
                else if (timeRange === '6M') cutoff.setMonth(now.getMonth() - 6);
                else if (timeRange === '1Y') cutoff.setFullYear(now.getFullYear() - 1);
                else cutoff = new Date(0); // ALL

                const filteredHistory = rsiData.history.filter(d => d.x >= cutoff.getTime());

                return {
                    ...chartData,
                    labels: filteredHistory.map(d => new Date(d.x).toLocaleDateString()),
                    datasets: [{
                        ...chartData.datasets[0],
                        data: filteredHistory.map(d => d.y),
                        pointRadius: filteredHistory.map(d => d.rsi <= 44 ? 3 : 0),
                        pointBackgroundColor: filteredHistory.map(d => d.rsi <= 25 ? '#ef4444' : (d.rsi <= 44 ? '#f97316' : 'rgba(0,0,0,0)')),
                        pointBorderColor: filteredHistory.map(d => d.rsi <= 25 ? '#ef4444' : (d.rsi <= 44 ? '#f97316' : 'rgba(0,0,0,0)')),
                    }]
                };
            }, [chartData, timeRange, rsiData]);

            if (loading) return <div className="flex justify-center items-center h-64"><RefreshCw className="animate-spin text-slate-500" size={32} /></div>;
            if (error) return (
                <div className="bg-red-900/20 border border-red-500/50 text-red-200 p-6 rounded-xl flex items-center gap-4">
                    <AlertTriangle size={24} className="shrink-0" />
                    <div>
                        <h3 className="font-bold text-lg">è‡ºè‚¡æ•¸æ“šè¼‰å…¥å¤±æ•—</h3>
                        <p className="text-sm opacity-90 my-2">{error}</p>
                        <button onClick={fetchData} className="px-4 py-2 bg-red-800 hover:bg-red-700 rounded text-sm transition-colors mt-2">
                            é‡è©¦é€£ç·š
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="space-y-6">
                    {/* å¤§ç›¤æŒ‡æ•¸å¡ç‰‡ */}
                    <SymbolSearch symbol={selectedSymbol} onSearch={setSelectedSymbol} placeholder="è¼¸å…¥ä»£è™Ÿ (e.g. 2330)" />

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <IndexPriceCard
                            name="åŠ æ¬ŠæŒ‡æ•¸ (^TWII)"
                            symbol="^TWII"
                            data={indices.twii}
                            suggestion={suggestion}
                        />
                        <IndexPriceCard
                            name="å…ƒå¤§å°ç£50 (0050)"
                            symbol="0050.TW"
                            data={indices.tw50}
                            suggestion={suggestion}
                        />
                        <IndexPriceCard
                            name="å…ƒå¤§é«˜è‚¡æ¯ (0056)"
                            symbol="0056.TW"
                            data={indices.tw56}
                            suggestion={suggestion}
                        />
                    </div>

                    {/* æ¨™é¡Œå€ */}
                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl flex flex-col items-center text-center">
                        <h2 className="text-xl font-bold text-slate-200 mb-2">è‡ºè‚¡æƒ…ç·’æŒ‡æ¨™ (åŸºæ–¼ {selectedSymbol} RSI)</h2>
                        <p className="text-xs text-slate-500 mb-4 max-w-md">
                            æ­¤æŒ‡æ¨™ä¸¦éææ‡¼è²ªå©ªæŒ‡æ•¸ã€‚æ•¸å€¼ç”±ã€{selectedSymbol}ã€çš„ 14 æ—¥ RSI å¼·å¼±æŒ‡æ¨™è¨ˆç®—å¾—å‡ºã€‚RSI ä½æ–¼ 30 ä»£è¡¨å¸‚å ´è¶…è³£ (ææ‡¼)ï¼Œé«˜æ–¼ 70 ä»£è¡¨å¸‚å ´è¶…è²· (è²ªå©ª)ã€‚
                            <span className="block mt-1 text-slate-600">æ•¸æ“šä¾†æº: {dataSource}</span>
                        </p>
                        <div className="w-full flex flex-col items-center">
                            {rsiData && (
                                <FearGreedGauge
                                    fngValue={rsiData.value}
                                    classification={rsiData.classification}
                                />
                            )}
                            {/* Sentiment Scarcity Bar (Show Full Year) */}
                            {rsiData && rsiData.history && (
                                <div className="w-full max-w-2xl mt-4 px-4">
                                    <SentimentScarcityBar
                                        data={rsiData.history.map(d => d.rsi)}
                                        title="éå» 1 å¹´è‡ºè‚¡è²·å…¥æ©Ÿæœƒåˆ†ä½ˆ (RSI)"
                                    />
                                </div>
                            )}
                        </div>
                    </div>

                    {/* ç­–ç•¥å»ºè­°å€ */}
                    {suggestion && (
                        <div className={`p-6 rounded-2xl border ${suggestion.border} ${suggestion.bg} relative overflow-hidden transition-all duration-500`}>
                            <div className="relative z-10 flex flex-col md:flex-row justify-between items-center w-full max-w-lg mx-auto mt-0">
                                <div className="flex flex-col items-start text-left mb-4 md:mb-0">
                                    <div className="text-sm uppercase tracking-wider opacity-70 mb-1">è‡ºè‚¡ DCA ç­–ç•¥</div>
                                    <span className={`text-2xl font-bold ${suggestion.text}`}>
                                        {suggestion.title}
                                    </span>
                                    <p className="mt-2 text-slate-300 max-w-lg text-sm">
                                        {suggestion.desc}
                                    </p>
                                </div>
                                <div className="flex flex-col items-center md:items-end gap-2 min-w-[140px] text-center md:text-right">
                                    <div className="text-sm text-slate-400">ç•¶å‰æ“ä½œ</div>
                                    <div className={`text-xl font-bold ${suggestion.text} border-2 border-current px-4 py-1 rounded-lg whitespace-nowrap`}>
                                        {suggestion.action}
                                    </div>
                                </div>
                            </div>
                            {/* AI Advice Integration */}
                            {rsiData && (
                                <AIAdviceBlock
                                    assetName={`å°è‚¡ (${selectedSymbol})`}
                                    marketData={`RSI(14): ${rsiData.value} (${rsiData.classification})`}
                                    priceStats={{
                                        current: rsiData.price,
                                        high: Math.max(...rsiData.history.map(d => d.y)),
                                        low: Math.min(...rsiData.history.map(d => d.y))
                                    }}
                                />
                            )}
                        </div>
                    )}

                    {/* æ­·å²èµ°å‹¢åœ– */}
                    {rsiData && (
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-semibold flex items-center gap-2">
                                    <TrendingUp size={18} className="text-slate-400" />
                                    {selectedSymbol} æ­·å²èµ°å‹¢èˆ‡è²·å…¥è¨Šè™Ÿ
                                </h2>
                                <TimeRangeSelector range={timeRange} onRangeChange={setTimeRange} />
                            </div>
                            <div className="h-[350px] w-full relative">
                                <ChartComponent data={displayChartData} options={chartOptions} />
                            </div>
                        </div>
                    )
                    }

                    {/* æ–°èå€ */}
                    <div className="mt-8">
                        <div className="flex items-center gap-2 mb-6">
                            <Newspaper className="text-blue-500" />
                            <h2 className="text-xl font-bold text-slate-200">è‡ºè‚¡è²¡ç¶“é ­æ¢ (Google News)</h2>
                        </div>

                        {!loading && !error && news.length > 0 && (
                            <>
                                <NewsAIAnalysis newsItems={news} />
                                <NewsSummary news={news} />
                            </>
                        )}

                        <NewsSection news={news} loading={loading} error={error} />
                    </div>

                    <div className="text-center text-slate-600 text-xs mt-8 pb-4">
                        è³‡æ–™ä¾†æº: Yahoo Finance, Google News, Smart DCA Bot (0050 æ­·å²æ•¸æ“šé‹ç®—)
                    </div>
                </div >
            );
        };




        // --- åŠ å¯†è²¨å¹£å„€è¡¨æ¿ (Updated to use CoinMarketCap) ---
        const CryptoDashboard = ({ notificationsEnabled, toggleNotifications }) => {
            const [selectedCoin, setSelectedCoin] = useState('bitcoin'); // slug or id
            const [timeRange, setTimeRange] = useState('1Y');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [historicalData, setHistoricalData] = useState([]);
            const [currentFNG, setCurrentFNG] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [prices, setPrices] = useState(null);
            const [newsData, setNewsData] = useState([]);
            const [newsLoading, setNewsLoading] = useState(true);
            const [newsError, setNewsError] = useState(null);

            // Fetch Current Price from CoinMarketCap (CMC)
            const fetchCurrentPrices = async (slugs = ['bitcoin', 'ethereum']) => {
                try {
                    // Use CORS Proxy to call CMC
                    const proxy = 'https://corsproxy.io/?url=';
                    const targetUrl = encodeURIComponent(`https://pro-api.coinmarketcap.com/v1/cryptocurrency/quotes/latest?slug=${slugs.join(',')}&CMC_PRO_API_KEY=${CMC_API_KEY}`);

                    const response = await fetch(`${proxy}${targetUrl}`, {
                        headers: {
                            'X-CMC_PRO_API_KEY': CMC_API_KEY
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // CMC Structure: { data: { "1": { ... }, "1027": { ... } } }
                        const newPrices = {};
                        Object.values(data.data).forEach(coin => {
                            newPrices[coin.slug] = {
                                usd: coin.quote.USD.price,
                                usd_24h_change: coin.quote.USD.percent_change_24h,
                                symbol: coin.symbol
                            };
                        });
                        setPrices(newPrices);
                    } else {
                        console.warn('CMC Price Fetch Failed:', await response.text());
                    }
                } catch (e) {
                    console.warn("CMC Price Fetch Error:", e);
                }
            };

            const fetchData = async () => {
                setLoading(true);
                setError(null);

                // Fetch Prices first
                const slugs = ['bitcoin', 'ethereum'];
                if (!slugs.includes(selectedCoin)) slugs.push(selectedCoin);
                fetchCurrentPrices(slugs);

                try {
                    // 1. Fetch FNG (Alternative.me)
                    const fngResponse = await fetch('https://api.alternative.me/fng/?limit=365');
                    const fngJson = await fngResponse.json();

                    // 2. Fetch Historical Data (CoinGecko fallback for history)
                    // Always fetch 365 days to allow local filtering
                    const days = '365';

                    let coinUrl = `https://api.coingecko.com/api/v3/coins/${selectedCoin}/market_chart?vs_currency=usd&days=${days}&interval=daily`;
                    let coinResponse = await fetch(coinUrl);

                    if (coinResponse.status === 404) {
                        try {
                            const searchRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${selectedCoin}`);
                            const searchData = await searchRes.json();
                            if (searchData.coins && searchData.coins.length > 0) {
                                setSelectedCoin(searchData.coins[0].id);
                                return;
                            }
                        } catch (e) { }
                    }

                    if (!coinResponse.ok) throw new Error("CoinGecko API Error (Historical Data)");
                    const coinJson = await coinResponse.json();

                    // Process FNG
                    const fngMap = new Map();
                    fngJson.data.forEach(item => {
                        const date = new Date(item.timestamp * 1000).toISOString().split('T')[0];
                        let rating = item.value_classification;
                        const ratingMap = {
                            "Extreme Fear": "æ¥µåº¦ææ‡¼", "extreme fear": "æ¥µåº¦ææ‡¼",
                            "Fear": "ææ‡¼", "fear": "ææ‡¼",
                            "Neutral": "ä¸­ç«‹", "neutral": "ä¸­ç«‹",
                            "Greed": "è²ªå©ª", "greed": "è²ªå©ª",
                            "Extreme Greed": "æ¥µåº¦è²ªå©ª", "extreme greed": "æ¥µåº¦è²ªå©ª"
                        };
                        rating = ratingMap[rating] || rating;
                        fngMap.set(date, { value: parseInt(item.value), classification: rating });
                    });

                    // Set Current FNG
                    const currentItem = fngJson.data[0];
                    let currentRating = currentItem.value_classification;
                    const ratingMap = { "Extreme Fear": "æ¥µåº¦ææ‡¼", "extreme fear": "æ¥µåº¦ææ‡¼", "Fear": "ææ‡¼", "fear": "ææ‡¼", "Neutral": "ä¸­ç«‹", "neutral": "ä¸­ç«‹", "Greed": "è²ªå©ª", "greed": "è²ªå©ª", "Extreme Greed": "æ¥µåº¦è²ªå©ª", "extreme greed": "æ¥µåº¦è²ªå©ª" };
                    setCurrentFNG({ ...currentItem, value_classification: ratingMap[currentRating] || currentRating });

                    // Merge
                    const mergedData = coinJson.prices.map(([timestamp, price]) => {
                        const dateObj = new Date(timestamp);
                        const dateStr = dateObj.toISOString().split('T')[0];
                        const fng = fngMap.get(dateStr) || { value: 50, classification: 'Neutral' };
                        return {
                            date: dateStr,
                            timestamp,
                            price,
                            fng: fng.value,
                            classification: fng.classification
                        };
                    });

                    setHistoricalData(mergedData);
                    setLastUpdated(new Date());

                } catch (err) {
                    console.error("Fetch Data Failed:", err);
                    setError(err.message + " (å¯èƒ½éœ€ç­‰å¾…ç”±APIé™åˆ¶)");
                } finally {
                    setLoading(false);
                }
            };

            const fetchNews = async () => {
                setNewsLoading(true);
                try {
                    const response = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.blocktempo.com/feed/');
                    const data = await response.json();
                    if (data.status === 'ok') setNewsData(data.items);
                } catch (e) {
                    setNewsError(e.message);
                } finally {
                    setNewsLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                fetchNews();
            }, [selectedCoin]); // Remove timeRange from re-fetch trigger

            // Local Filtering for Chart
            const chartData = useMemo(() => {
                if (!historicalData.length) return null;

                const now = new Date();
                let cutoff = new Date();
                if (timeRange === '1M') cutoff.setMonth(now.getMonth() - 1);
                else if (timeRange === '6M') cutoff.setMonth(now.getMonth() - 6);
                else if (timeRange === '1Y') cutoff.setFullYear(now.getFullYear() - 1);
                else cutoff = new Date(0); // ALL

                const filteredData = historicalData.filter(d => new Date(d.date) >= cutoff);

                const labels = filteredData.map(d => d.date);
                const prices = filteredData.map(d => d.price);

                return {
                    labels,
                    datasets: [{
                        label: `${selectedCoin.toUpperCase()} åƒ¹æ ¼ (USD)`,
                        data: prices,
                        borderColor: '#3b82f6',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        pointBackgroundColor: filteredData.map(d => d.fng <= 25 ? '#ef4444' : (d.fng <= 44 ? '#f97316' : 'rgba(0,0,0,0)')),
                        pointBorderColor: filteredData.map(d => d.fng <= 25 ? '#ef4444' : (d.fng <= 44 ? '#f97316' : 'rgba(0,0,0,0)')),
                        pointRadius: filteredData.map(d => d.fng <= 44 ? (d.fng <= 25 ? 3 : 2) : 0),
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                };
            }, [historicalData, selectedCoin, timeRange]);

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        callbacks: {
                            label: (context) => {
                                const index = context.dataIndex;
                                const data = historicalData[index];
                                return [`åƒ¹æ ¼: $${formatPrice(data.price)}`, `ææ‡¼è²ªå©ªæŒ‡æ•¸: ${data.fng} (${data.classification})`, data.fng <= 40 ? 'ğŸ”´ å»ºè­° DCA è²·å…¥é»' : 'âšª è§€æœ›'];
                            }
                        }
                    },
                    title: { display: true, text: `${selectedCoin.toUpperCase()} æ­·å²èµ°å‹¢ (ç´…é»ç‚ºææ‡¼è²·å…¥è¨Šè™Ÿ)`, color: '#94a3b8' }
                },
                scales: {
                    x: { grid: { color: 'rgba(75, 85, 99, 0.2)' }, ticks: { color: '#9ca3af', maxTicksLimit: 8 } },
                    y: { grid: { color: 'rgba(75, 85, 99, 0.2)' }, ticks: { color: '#9ca3af', callback: (value) => `$${formatPrice(value)}` } }
                }
            };

            const getSuggestion = () => {
                if (!currentFNG) return { text: "è¼‰å…¥ä¸­...", color: "text-gray-400" };
                const val = parseInt(currentFNG.value);
                if (val <= 25) return { title: "æ¥µåº¦ææ‡¼ (Extreme Fear)", action: "å¼·åŠ›è²·å…¥", desc: "å¸‚å ´æ¥µåº¦ææ…Œï¼Œé€™æ˜¯æ­·å²ä¸Šæœ€ä½³çš„ç´¯ç©ç±Œç¢¼æ™‚æ©Ÿã€‚", bg: "bg-red-900/30", border: "border-red-500", text: "text-red-400" };
                if (val <= 44) return { title: "ææ‡¼ (Fear)", action: "åˆ†æ‰¹è²·å…¥", desc: "å¸‚å ´æƒ…ç·’ä½è¿·ï¼Œé©åˆåŸ·è¡Œæ¨™æº– DCA ç­–ç•¥ã€‚", bg: "bg-orange-900/30", border: "border-orange-500", text: "text-orange-400" };
                if (val <= 55) return { title: "ä¸­ç«‹ (Neutral)", action: "æŒæœ‰è§€æœ›", desc: "å¸‚å ´æ–¹å‘ä¸æ˜ï¼Œå»ºè­°æš«åœå¤§é¡è²·å…¥ï¼Œä¿æŒè§€æœ›ã€‚", bg: "bg-gray-800", border: "border-gray-600", text: "text-gray-400" };
                if (val <= 74) return { title: "è²ªå©ª (Greed)", action: "åœæ­¢è²·å…¥", desc: "å¸‚å ´æƒ…ç·’éç†±ï¼Œé¢¨éšªå¢åŠ ï¼Œä¸å»ºè­°æ­¤æ™‚é€²è¡Œ DCAã€‚", bg: "bg-green-900/30", border: "border-green-500", text: "text-green-400" };
                return { title: `æ¥µåº¦è²ªå©ª (Extreme Greed)`, action: "æ­¢ç›ˆ/æ¸›å€‰", desc: "å¸‚å ´æ¥µåº¦éç†±ï¼Œå¼·çƒˆå»ºè­°æ­¢ç›ˆæˆ–åœæ­¢æ‰€æœ‰è²·å…¥æ“ä½œã€‚", bg: "bg-blue-900/30", border: "border-blue-500", text: "text-blue-400" };
            };
            const suggestion = getSuggestion();

            return (
                <div className="space-y-6">
                    <SymbolSearch symbol={selectedCoin} onSearch={setSelectedCoin} placeholder="è¼¸å…¥å¹£ç¨® (e.g. solana)" transformInput={(s) => s.toLowerCase()} />
                    <div className="flex gap-4 w-full flex-wrap">
                        <div onClick={() => setSelectedCoin('bitcoin')} className={`cursor-pointer flex flex-col flex-1 p-4 rounded-xl border transition-all ${selectedCoin === 'bitcoin' ? 'bg-slate-800 border-blue-500 shadow-lg' : 'bg-slate-900/50 border-slate-800'}`}>
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" className="w-6 h-6" alt="BTC" />
                                    <span className="font-bold text-white">BTC</span>
                                </div>
                            </div>
                            <div className="text-xl font-mono text-white">{prices && prices['bitcoin'] ? `$${formatPrice(prices['bitcoin'].usd)}` : 'Loading...'}</div>
                            {prices && prices['bitcoin'] && <div className={`text-xs ${prices['bitcoin'].usd_24h_change >= 0 ? 'text-green-400' : 'text-red-400'}`}>{prices['bitcoin'].usd_24h_change.toFixed(2)}%</div>}
                        </div>
                        <div onClick={() => setSelectedCoin('ethereum')} className={`cursor-pointer flex flex-col flex-1 p-4 rounded-xl border transition-all ${selectedCoin === 'ethereum' ? 'bg-slate-800 border-blue-500 shadow-lg' : 'bg-slate-900/50 border-slate-800'}`}>
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-2">
                                    <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" className="w-6 h-6" alt="ETH" />
                                    <span className="font-bold text-white">ETH</span>
                                </div>
                            </div>
                            <div className="text-xl font-mono text-white">{prices && prices['ethereum'] ? `$${formatPrice(prices['ethereum'].usd)}` : 'Loading...'}</div>
                            {prices && prices['ethereum'] && <div className={`text-xs ${prices['ethereum'].usd_24h_change >= 0 ? 'text-green-400' : 'text-red-400'}`}>{prices['ethereum'].usd_24h_change.toFixed(2)}%</div>}
                        </div>
                        {!['bitcoin', 'ethereum'].includes(selectedCoin) && (
                            <div className={`cursor-pointer flex flex-col flex-1 p-4 rounded-xl border transition-all bg-slate-800 border-blue-500 shadow-lg`}>
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <div className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs">?</div>
                                        <span className="font-bold text-white">{selectedCoin.toUpperCase()}</span>
                                    </div>
                                </div>
                                <div className="text-xl font-mono text-white">{prices && prices[selectedCoin] ? `$${formatPrice(prices[selectedCoin].usd)}` : 'Loading...'}</div>
                                {prices && prices[selectedCoin] && <div className={`text-xs ${prices[selectedCoin].usd_24h_change >= 0 ? 'text-green-400' : 'text-red-400'}`}>{prices[selectedCoin].usd_24h_change.toFixed(2)}%</div>}
                            </div>
                        )}
                    </div>

                    {loading && !historicalData.length ? (
                        <div className="h-64 flex flex-col items-center justify-center text-slate-500 gap-4"><RefreshCw className="animate-spin" size={32} /><p>æ­£åœ¨åŒæ­¥ CoinMarketCap æ•¸æ“š...</p></div>
                    ) : error ? (
                        <div className="bg-red-900/20 border border-red-500/50 text-red-200 p-6 rounded-xl flex items-center gap-4"><AlertTriangle size={24} /><div><h3 className="font-bold text-lg">è¼‰å…¥å¤±æ•—</h3><p className="text-sm opacity-90 my-2">{error}</p><button onClick={fetchData} className="px-4 py-2 bg-red-800 rounded">é‡è©¦</button></div></div>
                    ) : (
                        <>
                            <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl flex flex-col items-center">
                                <h2 className="text-xl font-bold text-slate-200 mb-4">åŠ å¯†è²¨å¹£ææ‡¼èˆ‡è²ªå©ªæŒ‡æ•¸</h2>
                                <FearGreedGauge fngValue={currentFNG?.value} classification={suggestion.title.split(' ')[0]} />
                                {historicalData.length > 0 && <div className="w-full max-w-2xl mt-4 px-4"><SentimentScarcityBar data={historicalData.map(d => d.fng)} title="éå» 365 å¤©æ©Ÿæœƒåˆ†ä½ˆ" /></div>}
                            </div>
                            <div className={`p-6 rounded-2xl border ${suggestion.border} ${suggestion.bg} relative overflow-hidden`}>
                                <div className="relative z-10 flex flex-col md:flex-row justify-between w-full max-w-lg mx-auto">
                                    <div className="flex flex-col"><div className="text-sm opacity-70">DCA ç­–ç•¥</div><span className={`text-2xl font-bold ${suggestion.text}`}>{suggestion.title}</span><p className="mt-2 text-slate-300 text-sm max-w-lg">{suggestion.desc}</p></div>
                                    <div className="flex flex-col items-center md:items-end gap-2 text-center md:text-right"><div className="text-sm text-slate-400">ç•¶å‰æ“ä½œ</div><div className={`text-xl font-bold ${suggestion.text} border-2 border-current px-4 py-1 rounded-lg`}>{suggestion.action}</div></div>
                                </div>
                                {currentFNG && prices && historicalData.length > 0 && (
                                    <div className="mt-4 border-t border-slate-700 pt-4">
                                        <AIAdviceBlock
                                            assetName={`åŠ å¯†è²¨å¹£ (${selectedCoin.toUpperCase()})`}
                                            priceStats={{ current: prices[selectedCoin]?.usd, high: Math.max(...historicalData.map(d => d.price)), low: Math.min(...historicalData.map(d => d.price)) }}
                                            marketData={`è³‡ç”¢: ${selectedCoin.toUpperCase()}\nåƒ¹æ ¼: $${formatPrice(prices[selectedCoin]?.usd)}\nææ‡¼è²ªå©ªæŒ‡æ•¸: ${currentFNG.value} (${currentFNG.value_classification})`}
                                        />
                                    </div>
                                )}
                            </div>
                            <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-lg font-semibold flex items-center gap-2"><TrendingUp size={18} className="text-slate-400" /> æ­·å²èµ°å‹¢ ({selectedCoin.toUpperCase()})</h2>
                                    <TimeRangeSelector range={timeRange} onRangeChange={setTimeRange} />
                                </div>
                                <div className="h-[300px] sm:h-[350px] w-full relative">
                                    {chartData && <ChartComponent data={chartData} options={chartOptions} />}
                                </div>
                            </div>
                            <div className="mt-8">
                                <div className="flex items-center gap-2 mb-6"><Newspaper className="text-blue-500" /><h2 className="text-xl font-bold text-slate-200">ä»Šæ—¥å¹£åœˆé ­æ¢</h2></div>
                                {!newsLoading && !newsError && newsData.length > 0 && <><NewsAIAnalysis newsItems={newsData} /><NewsSummary news={newsData} /></>}
                                <NewsSection news={newsData} loading={newsLoading} error={newsError} />
                            </div>
                            <div className="bg-slate-900 p-5 rounded-xl border border-slate-800 mt-6"><h3 className="font-bold text-slate-200 mb-3 flex items-center gap-2"><Info size={18} />é—œæ–¼æ•¸æ“šä¾†æº</h3><div className="text-sm text-slate-400 space-y-2"><p><strong>åƒ¹æ ¼æ•¸æ“š:</strong> CoinMarketCap (å³æ™‚), CoinGecko (æ­·å²)</p><p><strong>æƒ…ç·’æŒ‡æ¨™:</strong> Alternative.me Crypto Fear & Greed Index</p></div></div>
                        </>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('crypto'); // 'crypto' or 'stock'
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);

            // åˆå§‹æª¢æŸ¥é€šçŸ¥æ¬Šé™
            useEffect(() => {
                if ("Notification" in window && Notification.permission === 'granted') {
                    setNotificationsEnabled(true);
                }
            }, []);

            // è™•ç†é€šçŸ¥é–‹é—œåˆ‡æ›
            const toggleNotifications = async () => {
                if (!("Notification" in window)) {
                    // ä½¿ç”¨ custom modal UI æ›¿æ› alert
                    const modal = document.createElement('div');
                    modal.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-white mb-3">é€šçŸ¥åŠŸèƒ½ä¸æ”¯æ´</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-300">æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Notification APIã€‚è«‹å˜—è©¦ä½¿ç”¨ Chrome, Firefox æˆ– Edge ç€è¦½å™¨ã€‚</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="this.parentNode.parentNode.remove()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm float-right">ç¢ºå®š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
                    document.body.appendChild(modal);
                    return;
                }

                // å¦‚æœç›®å‰æ˜¯é–‹å•Ÿç‹€æ…‹ -> é—œé–‰ (Local Mute)
                if (notificationsEnabled) {
                    setNotificationsEnabled(false);
                    return;
                }

                // å¦‚æœç›®å‰æ˜¯é—œé–‰ç‹€æ…‹ -> é–‹å•Ÿ
                if (Notification.permission === 'granted') {
                    setNotificationsEnabled(true);
                    new Notification("é€šçŸ¥å·²å•Ÿç”¨ âœ…", {
                        body: "Smart DCA Bot å·²æº–å‚™å¥½ï¼ç•¶ææ‡¼æŒ‡æ•¸é”åˆ°è²·å…¥å€é–“æ™‚ï¼Œæˆ‘å€‘æœƒç«‹å³é€šçŸ¥æ‚¨ã€‚",
                        icon: "https://cryptologos.cc/logos/bitcoin-btc-logo.png"
                    });
                } else if (Notification.permission === 'denied') {
                    const modal = document.createElement('div');
                    modal.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-red-400 mb-3">æ¬Šé™è¢«å°é–</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-300">é€šçŸ¥æ¬Šé™å·²è¢«æ‚¨çš„ç€è¦½å™¨å°é–ã€‚è«‹å‰å¾€ç€è¦½å™¨è¨­å®š (ç¶²å€åˆ—æ—çš„é–é ­åœ–ç¤º) æ‰‹å‹•é–‹å•Ÿæ¬Šé™ã€‚</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="this.parentNode.parentNode.remove()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm float-right">æˆ‘çŸ¥é“äº†</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
                    document.body.appendChild(modal);
                } else {
                    // è«‹æ±‚æ¬Šé™
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        setNotificationsEnabled(true);
                        new Notification("é€šçŸ¥å·²å•Ÿç”¨ âœ…", {
                            body: "Smart DCA Bot å·²æº–å‚™å¥½ï¼ç•¶ææ‡¼æŒ‡æ•¸é”åˆ°è²·å…¥å€é–“æ™‚ï¼Œæˆ‘å€‘æœƒç«‹å³é€šçŸ¥æ‚¨ã€‚",
                            icon: "https://cryptologos.cc/logos/bitcoin-btc-logo.png"
                        });
                    }
                }
            };

            return (
                <div className="min-h-screen text-slate-300 font-sans selection:bg-blue-500/30">
                    <div className="max-w-4xl mx-auto p-4 pb-24">
                        {/* Header */}
                        {/* Header */}
                        <header className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-3">
                                <div className="relative">
                                    <div className="absolute inset-0 bg-blue-500 blur-lg opacity-20 rounded-full"></div>
                                    <img src="./app-icon.png" alt="Smart DCA Logo" className="w-10 h-10 rounded-xl shadow-lg shadow-blue-500/20 relative z-10" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 tracking-tight">
                                        Smart DCA
                                    </h1>
                                    <p className="text-xs text-slate-500 font-medium tracking-wide">INTELLIGENT INVESTING</p>
                                </div>
                            </div>
                            <button
                                onClick={toggleNotifications}
                                className={`flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all duration-300 ${notificationsEnabled
                                    ? 'bg-blue-900/30 border-blue-500/50 text-blue-400'
                                    : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-600'
                                    }`}
                            >
                                <div className={`w-2 h-2 rounded-full ${notificationsEnabled ? 'bg-blue-400 animate-pulse' : 'bg-slate-600'}`}></div>
                                <span className="text-xs font-bold hidden md:block">{notificationsEnabled ? 'é€šçŸ¥å·²é–‹å•Ÿ' : 'é€šçŸ¥å·²é—œé–‰'}</span>
                                {notificationsEnabled ? <BellRing size={18} /> : <BellOff size={18} />}
                            </button>
                        </header>

                        {/* Navigation Tabs */}
                        <nav className="flex p-1 bg-slate-800/50 backdrop-blur-md rounded-xl mb-6 border border-slate-700/50 sticky top-4 z-50 shadow-xl">
                            <button
                                onClick={() => setActiveTab('crypto')}
                                className={`flex-1 py-2.5 px-4 rounded-lg text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 ${activeTab === 'crypto'
                                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20 scale-[1.02]'
                                    : 'text-slate-400 hover:text-white hover:bg-slate-700/50'
                                    }`}
                            >
                                <img src="https://assets.coingecko.com/coins/images/1/small/bitcoin.png" className="w-4 h-4 opacity-80" alt="Crypto" />
                                åŠ å¯†è²¨å¹£
                            </button>
                            <button
                                onClick={() => setActiveTab('stock')}
                                className={`flex-1 py-2.5 px-4 rounded-lg text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 ${activeTab === 'stock'
                                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20 scale-[1.02]'
                                    : 'text-slate-400 hover:text-white hover:bg-slate-700/50'
                                    }`}
                            >
                                <Globe size={16} />
                                ç¾è‚¡å¸‚å ´
                            </button>
                            <button
                                onClick={() => setActiveTab('taiwan')}
                                className={`flex-1 py-2.5 px-4 rounded-lg text-sm font-bold transition-all duration-300 flex items-center justify-center gap-2 ${activeTab === 'taiwan'
                                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20 scale-[1.02]'
                                    : 'text-slate-400 hover:text-white hover:bg-slate-700/50'
                                    }`}
                            >
                                <Activity size={16} />
                                è‡ºè‚¡å¸‚å ´
                            </button>
                        </nav>

                        {/* Content Area */}
                        <main>
                            {activeTab === 'crypto' && (
                                <CryptoDashboard
                                    notificationsEnabled={notificationsEnabled}
                                    toggleNotifications={toggleNotifications}
                                />
                            )}
                            {activeTab === 'stock' && (
                                <StockDashboard
                                    notificationsEnabled={notificationsEnabled}
                                    toggleNotifications={toggleNotifications}
                                />
                            )}
                            {activeTab === 'taiwan' && (
                                <TaiwanDashboard />
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
