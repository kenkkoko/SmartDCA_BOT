<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart DCA Bot - ææ‡¼è²ªå©ªæŒ‡æ•¸ç­–ç•¥</title>
    <link rel="icon" type="image/png" href="./app-icon.png" />

    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- å¼•å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- å¼•å…¥ Chart.js (ç¢ºä¿ä½¿ç”¨ UMD ç‰ˆæœ¬) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            background-color: #0f172a; /* slate-950 */
        }
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* ç§»é™¤èˆŠçš„æŒ‡é‡ CSSï¼Œä½¿ç”¨ SVG å…§å»ºå‹•ç•« */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- å…§å»º Icons (å–ä»£å¤–éƒ¨ lucide-react ä¾è³´) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Icons = {
            Bell: (props) => (
                <IconBase {...props}>
                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
                </IconBase>
            ),
            TrendingUp: (props) => (
                <IconBase {...props}>
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                    <polyline points="17 6 23 6 23 12" />
                </IconBase>
            ),
            AlertTriangle: (props) => (
                <IconBase {...props}>
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                    <line x1="12" y1="9" x2="12" y2="13" />
                    <line x1="12" y1="17" x2="12.01" y2="17" />
                </IconBase>
            ),
            Info: (props) => (
                <IconBase {...props}>
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="16" x2="12" y2="12" />
                    <line x1="12" y1="8" x2="12.01" y2="8" />
                </IconBase>
            ),
            RefreshCw: (props) => (
                <IconBase {...props}>
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
                    <path d="M21 3v5h-5" />
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
                    <path d="M8 16H3v5" />
                </IconBase>
            ),
            Smartphone: (props) => (
                <IconBase {...props}>
                    <rect width="14" height="20" x="5" y="2" rx="2" ry="2" />
                    <path d="M12 18h.01" />
                </IconBase>
            ),
            ArrowUp: (props) => (
                <IconBase {...props}>
                    <line x1="12" y1="19" x2="12" y2="5" />
                    <polyline points="5 12 12 5 19 12" />
                </IconBase>
            ),
            ArrowDown: (props) => (
                <IconBase {...props}>
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <polyline points="19 12 12 19 5 12" />
                </IconBase>
            )
        };

        const { Bell, TrendingUp, AlertTriangle, Info, RefreshCw, Smartphone, ArrowUp, ArrowDown } = Icons;

        // --- ææ‡¼è²ªå©ªæŒ‡æ•¸å„€è¡¨æ¿å…ƒä»¶ ---
        const FearGreedGauge = ({ fngValue, classification }) => {
            // FNG ç¯„åœå°æ‡‰åˆ° 180 åº¦çš„åŠåœ“
            // 0 -> 180deg (å·¦å´), 100 -> 0deg (å³å´)
            const angleFromRight = Math.min(180, Math.max(0, (fngValue / 100) * 180));
            const indicatorAngleDeg = 180 - angleFromRight; 

            // é¡è‰²å€å¡Šçš„ç²¾ç¢ºè§’åº¦åŠƒåˆ† (0-25, 26-44, 45-55, 56-74, 75-100)
            const segments = [
                // FNG 0-25 (45åº¦): ç´…è‰² (Extreme Fear)
                { startAngle: 180, endAngle: 135, color: '#EA3943' }, 
                // FNG 26-44 (34.2åº¦): æ©˜è‰² (Fear)
                { startAngle: 135, endAngle: 100.8, color: '#EA8C00' },  
                // FNG 45-55 (19.8åº¦): é»ƒè‰² (Neutral)
                { startAngle: 100.8, endAngle: 81, color: '#F3D42F' },   
                // FNG 56-74 (34.2åº¦): äº®ç¶ è‰² (Greed)
                { startAngle: 81, endAngle: 46.8, color: '#93D900' },   
                // FNG 75-100 (46.8åº¦): é’ç¶ è‰² (Extreme Greed)
                { startAngle: 46.8, endAngle: 0, color: '#16C784' },    
            ];

            // æ ¹æ“šåƒè€ƒç¶²ç«™çš„ SVG åƒæ•¸é€²è¡Œèª¿æ•´
            const size = 144; // åƒè€ƒç¶²ç«™çš„ SVG å¯¬åº¦
            const radius = 59; // åƒè€ƒç¶²ç«™çš„åŠå¾‘
            const strokeWidth = 10; 
            const indicatorRadius = 7; // æŒ‡æ¨™åŠå¾‘ (å¤–åœˆ)
            const indicatorInnerRadius = 5; // æŒ‡æ¨™åŠå¾‘ (å…§åœˆ)

            // åœ“å¿ƒåº§æ¨™ (X è»¸ä¸­å¤®)
            const centerX = size / 2; // 72
            // åœ“å¿ƒ Y åº§æ¨™ï¼šé…åˆæ–°çš„ strokeWidth é€²è¡Œèª¿æ•´
            const centerY = radius + strokeWidth / 2 + 15; // 79

            // 1. åº§æ¨™è½‰æ›å·¥å…·
            const getCoords = (angleDeg) => {
                const angleRad = (angleDeg) * (Math.PI / 180); 
                return {
                    x: centerX + radius * Math.cos(angleRad),
                    // ç¢ºä¿å‘ä¸Šé–‹å•Ÿ
                    y: centerY - radius * Math.sin(angleRad) 
                };
            };

            // 2. ç¹ªè£½åœ“å¼§è·¯å¾‘å·¥å…· (ä½¿ç”¨ A å¼§ç·šæŒ‡ä»¤)
            const getArcPath = (startAngle, endAngle) => {
                const start = getCoords(startAngle);
                const end = getCoords(endAngle);
                const largeArcFlag = 0; 
                // sweepFlag = 1ï¼Œç¢ºä¿åœ“å¼§æ˜¯å‘å¤–å‡¸å‡º
                const sweepFlag = 1; 

                return [
                    "M", start.x, start.y, 
                    "A", radius, radius, 0, largeArcFlag, sweepFlag, end.x, end.y
                ].join(" ");
            };

            // æŒ‡æ¨™ä½ç½®
            const indicatorPosition = getCoords(indicatorAngleDeg); 

            // è¨ˆç®— viewBox é«˜åº¦ï¼Œç¢ºä¿èƒ½å®¹ç´åœ“å¼§å’ŒæŒ‡æ¨™ä»¥åŠä¸­å¤®æ–‡å­—ã€‚
            const viewBoxHeight = centerY + 10; 

            return (
                // å®¹å™¨è¨­ç‚ºéŸ¿æ‡‰å¼å¯¬åº¦ï¼Œæœ€å¤§ä¸è¶…é 200px (ä»¥é©æ‡‰å°å°ºå¯¸çš„å„€è¡¨æ¿)ã€‚
                <div className="relative w-full max-w-[200px] mx-auto flex flex-col items-center">
                    <svg 
                        className="w-full h-auto" // è®“ SVG ä½”æ»¿å®¹å™¨å¯¬åº¦ä¸¦ä¿æŒé•·å¯¬æ¯”
                        viewBox={`0 0 ${size} ${viewBoxHeight}`} 
                    >
                        
                        {/* ç¹ªè£½åˆ†æ®µåœ“å¼§ */}
                        <g>
                            {segments.map((segment, index) => (
                                <path
                                    key={index}
                                    d={getArcPath(segment.startAngle, segment.endAngle)}
                                    fill="none"
                                    stroke={segment.color}
                                    strokeWidth={strokeWidth}
                                    // ä¿®æ­£ï¼šç§»é™¤ strokeLinecap="round" ä»¥é¿å…è‰²å¡Šé‡ç–Š/å…¥ä¾µ
                                    strokeLinecap="butt" 
                                    className="drop-shadow-sm transition-all duration-500"
                                />
                            ))}

                            {/* æŒ‡æ¨™å¤–åœˆ (ç™½è‰²é‚Šæ¡†) */}
                            <circle
                                cx={indicatorPosition.x}
                                cy={indicatorPosition.y}
                                r={indicatorRadius}
                                fill="none"
                                stroke="#d1d5db" // ç°è‰²é‚Šæ¡† (è¿‘ä¼¼åƒè€ƒåœ–)
                                strokeWidth="4"
                                className="transition-all duration-1000 ease-out"
                            />
                            {/* æŒ‡æ¨™å…§åœˆ (ç™½è‰²å¡«å……) */}
                            <circle
                                cx={indicatorPosition.x}
                                cy={indicatorPosition.y}
                                r={indicatorInnerRadius}
                                fill="white"
                                className="transition-all duration-1000 ease-out"
                            />
                        </g>

                        {/* ä¸­å¤®æ•¸å€¼å’Œåˆ†é¡æ–‡å­— (ç½®æ–¼ SVG åœ“å¼§ä¸­é–“) */}
                        <text
                            x={centerX}
                            // Y è»¸èª¿æ•´ï¼šæ•¸å€¼ä½ç½® 
                            y={centerY - 28} 
                            textAnchor="middle"
                            dominantBaseline="middle"
                            className="fill-white font-black"
                            // ä¿®æ­£ï¼šç¸®å°å­—é«”åˆ° 28px
                            style={{ fontSize: '28px', lineHeight: 1 }} 
                        >
                            {fngValue}
                        </text>
                        <text
                            x={centerX}
                            // Y è»¸èª¿æ•´ï¼šåˆ†é¡ä½ç½®
                            y={centerY + 3} 
                            textAnchor="middle"
                            dominantBaseline="middle"
                            className="fill-slate-400 font-medium"
                            style={{ fontSize: '16px' }} 
                        >
                            {classification}
                        </text>
                    </svg>
                    
                    {/* å„€è¡¨æ¿åˆ»åº¦æ–‡å­— (0, 25, 50, 75, 100) - å·²ç§»é™¤ */}
                </div>
            );
        };


        // --- è‡ªå®šç¾© Chart å…ƒä»¶ ---
        const ChartComponent = ({ data, options, type = 'line' }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: options
                });
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, options, type]);

            return <canvas ref={chartRef} />;
        };

        const App = () => {
            const [selectedCoin, setSelectedCoin] = useState('bitcoin');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [historicalData, setHistoricalData] = useState([]);
            const [currentFNG, setCurrentFNG] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [prices, setPrices] = useState(null);
            
            // é€šçŸ¥é–‹é—œç‹€æ…‹ (å¸ƒæ—å€¼ï¼Œæ§åˆ¶ UI é–‹é—œ)
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);

            // åˆå§‹æª¢æŸ¥é€šçŸ¥æ¬Šé™
            useEffect(() => {
                if ("Notification" in window && Notification.permission === 'granted') {
                    setNotificationsEnabled(true);
                }
            }, []);

            // è™•ç†é€šçŸ¥é–‹é—œåˆ‡æ›
            const toggleNotifications = async () => {
                if (!("Notification" in window)) {
                    // ä½¿ç”¨ custom modal UI æ›¿æ› alert
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                            <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
                                <h3 class="text-xl font-bold text-white mb-3">é€šçŸ¥åŠŸèƒ½ä¸æ”¯æ´</h3>
                                <p class="text-slate-300">æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Notification APIã€‚è«‹å˜—è©¦ä½¿ç”¨ Chrome, Firefox æˆ– Edge ç€è¦½å™¨ã€‚</p>
                                <button onclick="this.parentNode.parentNode.remove()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm float-right">ç¢ºå®š</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    return;
                }

                // å¦‚æœç›®å‰æ˜¯é–‹å•Ÿç‹€æ…‹ -> é—œé–‰ (Local Mute)
                if (notificationsEnabled) {
                    setNotificationsEnabled(false);
                    return;
                }

                // å¦‚æœç›®å‰æ˜¯é—œé–‰ç‹€æ…‹ -> é–‹å•Ÿ
                if (Notification.permission === 'granted') {
                    setNotificationsEnabled(true);
                    sendTestNotification();
                } else if (Notification.permission === 'denied') {
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                            <div class="bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full border border-slate-700">
                                <h3 class="text-xl font-bold text-red-400 mb-3">æ¬Šé™è¢«å°é–</h3>
                                <p class="text-slate-300">é€šçŸ¥æ¬Šé™å·²è¢«æ‚¨çš„ç€è¦½å™¨å°é–ã€‚è«‹å‰å¾€ç€è¦½å™¨è¨­å®š (ç¶²å€åˆ—æ—çš„é–é ­åœ–ç¤º) æ‰‹å‹•é–‹å•Ÿæ¬Šé™ã€‚</p>
                                <button onclick="this.parentNode.parentNode.remove()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm float-right">æˆ‘çŸ¥é“äº†</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    // è«‹æ±‚æ¬Šé™
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        setNotificationsEnabled(true);
                        sendTestNotification();
                    }
                }
            };

            const sendTestNotification = () => {
                new Notification("é€šçŸ¥å·²å•Ÿç”¨ âœ…", {
                    body: "Smart DCA Bot å·²æº–å‚™å¥½ï¼ç•¶ææ‡¼æŒ‡æ•¸é”åˆ°è²·å…¥å€é–“æ™‚ï¼Œæˆ‘å€‘æœƒç«‹å³é€šçŸ¥æ‚¨ã€‚",
                    icon: "https://cryptologos.cc/logos/bitcoin-btc-logo.png"
                });
            };

            const triggerBuySignalNotification = (fngValue, coinName) => {
                // åªæœ‰åœ¨é–‹é—œé–‹å•Ÿ (notificationsEnabled ç‚º true) æ™‚æ‰ç™¼é€
                if (notificationsEnabled && Notification.permission === 'granted') {
                    let intensity = "å°‘é‡ DCA";
                    if (fngValue <= 25) intensity = "æ¥µåº¦ææ‡¼ï¼å»ºè­°å¼·åŠ›è²·å…¥";
                    else if (fngValue <= 45) intensity = "ææ‡¼éšæ®µï¼Œå»ºè­°åŠ ç¢¼";

                    new Notification(`DCA è¨Šè™Ÿè§¸ç™¼: ${coinName.toUpperCase()}`, {
                        body: `ä»Šæ—¥ææ‡¼æŒ‡æ•¸ç‚º ${fngValue}ã€‚å»ºè­°æ“ä½œï¼š${intensity}`,
                        icon: coinName === 'bitcoin' 
                            ? "https://cryptologos.cc/logos/bitcoin-btc-logo.png" 
                            : "https://cryptologos.cc/logos/ethereum-eth-logo.png"
                    });
                }
            };

            const fetchCurrentPrices = async () => {
                try {
                    // ä½¿ç”¨ fetch APIï¼Œé€™è£¡ä¸ä½¿ç”¨ google.search
                    const response = await fetch(
                        'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd&include_24hr_change=true'
                    );
                    if (response.ok) {
                        const data = await response.json();
                        setPrices(data);
                    }
                } catch (e) {
                    console.warn("å³æ™‚åƒ¹æ ¼æ›´æ–°å¤±æ•—:", e);
                }
            };

            const fetchData = async () => {
                setLoading(true);
                setError(null);

                fetchCurrentPrices();

                try {
                    const fetchWithTimeout = (url, timeout = 10000) => {
                        return Promise.race([
                            fetch(url),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('API è«‹æ±‚é€¾æ™‚ (Timeout)ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦')), timeout)
                            )
                        ]);
                    };

                    const fngResponse = await fetchWithTimeout('https://api.alternative.me/fng/?limit=365');
                    if (!fngResponse.ok) {
                        throw new Error(`FNG API Error: ${fngResponse.status}`);
                    }
                    const fngJson = await fngResponse.json();

                    if (fngJson.metadata && fngJson.metadata.error) {
                        throw new Error("FNG API è¿”å›éŒ¯èª¤");
                    }

                    const coinResponse = await fetchWithTimeout(
                        `https://api.coingecko.com/api/v3/coins/${selectedCoin}/market_chart?vs_currency=usd&days=365&interval=daily`
                    );
                    
                    if (!coinResponse.ok) {
                        if (coinResponse.status === 429) {
                            throw new Error("CoinGecko API è«‹æ±‚éæ–¼é »ç¹ (Rate Limit)ï¼Œè«‹ç­‰å¾… 1 åˆ†é˜å¾Œå†é‡æ–°æ•´ç†é é¢ã€‚");
                        }
                        throw new Error(`CoinGecko API Error: ${coinResponse.status} - ç„¡æ³•ç²å–åƒ¹æ ¼æ•¸æ“š`);
                    }
                    const coinJson = await coinResponse.json();

                    const fngMap = new Map();
                    fngJson.data.forEach(item => {
                        const date = new Date(item.timestamp * 1000).toISOString().split('T')[0];
                        fngMap.set(date, {
                            value: parseInt(item.value),
                            classification: item.value_classification
                        });
                    });

                    setCurrentFNG(fngJson.data[0]);

                    const mergedData = coinJson.prices.map(([timestamp, price]) => {
                        const dateObj = new Date(timestamp);
                        const dateStr = dateObj.toISOString().split('T')[0];
                        const fngData = fngMap.get(dateStr) || { value: 50, classification: 'Neutral' };

                        return {
                            date: dateStr,
                            timestamp,
                            price,
                            fng: fngData.value,
                            classification: fngData.classification
                        };
                    });

                    setHistoricalData(mergedData);
                    setLastUpdated(new Date());

                    // æª¢æŸ¥æ˜¯å¦éœ€è¦ç™¼é€é€šçŸ¥
                    const todayFng = parseInt(fngJson.data[0].value);
                    if (todayFng <= 45) {
                        // ç”±æ–¼é–‰åŒ…å•é¡Œï¼Œç›´æ¥ä½¿ç”¨ state å¯èƒ½æœƒæœ‰èˆŠå€¼ï¼Œæˆ‘å€‘é€™è£¡ç°¡å–®ä¾è³´è§¸ç™¼é‚è¼¯ä¸­çš„å³æ™‚æª¢æŸ¥
                        // ç‚ºäº†ç¢ºä¿é¦–æ¬¡è¼‰å…¥èƒ½è§¸ç™¼ï¼ˆå¦‚æœå·²ç¶“é–‹å•Ÿï¼‰ï¼Œæˆ‘å€‘å‚³é state
                        triggerBuySignalNotification(todayFng, selectedCoin);
                    }

                } catch (err) {
                    console.error("Data fetch failed:", err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, [selectedCoin]);

            const chartData = useMemo(() => {
                if (!historicalData.length) return null;

                const labels = historicalData.map(d => d.date);
                const prices = historicalData.map(d => d.price);
                
                const pointColors = historicalData.map(d => {
                    if (d.fng <= 20) return '#ef4444'; 
                    if (d.fng <= 40) return '#f97316'; 
                    return 'rgba(0,0,0,0)'; 
                });

                // ä¿®æ­£: ç¸®å°ç´…é»å’Œæ©˜é»çš„å°ºå¯¸ (pointRadius)
                const pointRadiuses = historicalData.map(d => {
                    if (d.fng <= 20) return 3; // å¾ 6 ç¸®å°åˆ° 3
                    if (d.fng <= 40) return 2; // å¾ 4 ç¸®å°åˆ° 2
                    return 0;
                });

                return {
                    labels,
                    datasets: [
                        {
                            label: `${selectedCoin === 'bitcoin' ? 'BTC' : 'ETH'} åƒ¹æ ¼ (USD)`,
                            data: prices,
                            borderColor: '#3b82f6',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
                                return gradient;
                            },
                            borderWidth: 2,
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointColors,
                            pointRadius: pointRadiuses,
                            pointHoverRadius: 4, // å¾ 8 ç¸®å°åˆ° 4
                            fill: true,
                            tension: 0.4
                        }
                    ]
                };
            }, [historicalData, selectedCoin]);

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#e5e7eb',
                        borderColor: '#374151',
                        borderWidth: 1,
                        callbacks: {
                            label: (context) => {
                                const index = context.dataIndex;
                                const data = historicalData[index];
                                return [
                                    `åƒ¹æ ¼: $${data.price.toLocaleString(undefined, {maximumFractionDigits: 0})}`,
                                    `ææ‡¼è²ªå©ªæŒ‡æ•¸: ${data.fng} (${data.classification})`,
                                    data.fng <= 40 ? 'ğŸ”´ å»ºè­° DCA è²·å…¥é»' : 'âšª è§€æœ›/æŒæœ‰'
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(75, 85, 99, 0.2)',
                        },
                        ticks: {
                            color: '#9ca3af',
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(75, 85, 99, 0.2)',
                        },
                        ticks: {
                            color: '#9ca3af',
                            callback: (value) => `$${value.toLocaleString()}`
                        }
                    }
                }
            };

            const getSuggestion = () => {
                if (!currentFNG) return { text: "è¼‰å…¥ä¸­...", color: "text-gray-400" };
                const val = parseInt(currentFNG.value);
                
                // ç­–ç•¥å»ºè­°å€é–“ä»¥åŒ¹é…å„€è¡¨æ¿å€é–“ (0-25, 26-44, 45-55, 56-74, 75-100)
                if (val <= 25) return { 
                    title: "æ¥µåº¦ææ‡¼ (Extreme Fear)", 
                    action: "å¼·åŠ›è²·å…¥", 
                    desc: "å¸‚å ´æ¥µåº¦ææ…Œï¼Œé€™æ˜¯æ­·å²ä¸Šæœ€ä½³çš„ç´¯ç©ç±Œç¢¼æ™‚æ©Ÿã€‚",
                    bg: "bg-red-900/30",
                    border: "border-red-500",
                    text: "text-red-400" 
                };
                if (val >= 26 && val <= 44) return { 
                    title: "ææ‡¼ (Fear)", 
                    action: "åˆ†æ‰¹è²·å…¥", 
                    desc: "å¸‚å ´æƒ…ç·’ä½è¿·ï¼Œé©åˆåŸ·è¡Œæ¨™æº– DCA ç­–ç•¥ã€‚",
                    bg: "bg-orange-900/30",
                    border: "border-orange-500",
                    text: "text-orange-400"
                };
                if (val >= 45 && val <= 55) return { 
                    title: "ä¸­ç«‹ (Neutral)", 
                    action: "æŒæœ‰è§€æœ›", 
                    desc: "å¸‚å ´æ–¹å‘ä¸æ˜ï¼Œå»ºè­°æš«åœå¤§é¡è²·å…¥ï¼Œä¿æŒè§€æœ›ã€‚",
                    bg: "bg-gray-800",
                    border: "border-gray-600",
                    text: "text-gray-400"
                };
                if (val >= 56 && val <= 74) return { 
                    title: "è²ªå©ª (Greed)", 
                    action: "åœæ­¢è²·å…¥ / è€ƒæ…®æ­¢ç›ˆ", 
                    desc: "å¸‚å ´æƒ…ç·’éç†±ï¼Œé¢¨éšªå¢åŠ ï¼Œä¸å»ºè­°æ­¤æ™‚é€²è¡Œ DCAã€‚",
                    bg: "bg-green-900/30",
                    border: "border-green-500",
                    text: "text-green-400"
                };
                return { 
                    title: `æ¥µåº¦è²ªå©ª (Extreme Greed)`, 
                    action: "æ¥µé«˜é¢¨éšª / æ­¢ç›ˆ", 
                    desc: "å¸‚å ´æ¥µåº¦éç†±ï¼Œå¼·çƒˆå»ºè­°æ­¢ç›ˆæˆ–åœæ­¢æ‰€æœ‰è²·å…¥æ“ä½œã€‚",
                    bg: "bg-blue-900/30",
                    border: "border-blue-500",
                    text: "text-blue-400"
                };
            };

            const suggestion = getSuggestion();

            const PriceCard = ({ id, name, symbol, iconUrl }) => {
                const isSelected = selectedCoin === id;
                const priceData = prices ? prices[id] : null;
                const price = priceData ? priceData.usd : null;
                const change = priceData ? priceData.usd_24h_change : null;
                const isPositive = change >= 0;

                return (
                    <button
                        onClick={() => setSelectedCoin(id)}
                        className={`flex flex-col flex-1 p-4 rounded-xl border transition-all duration-300 relative overflow-hidden ${
                            isSelected 
                                ? 'bg-slate-800 border-blue-500 shadow-lg shadow-blue-500/20' 
                                : 'bg-slate-900/50 border-slate-800 hover:bg-slate-800 hover:border-slate-700'
                        }`}
                    >
                        <div className="flex items-center justify-between w-full mb-2">
                            <div className="flex items-center gap-2">
                                <img src={iconUrl} alt={name} className="w-6 h-6" />
                                <span className={`font-bold ${isSelected ? 'text-white' : 'text-slate-400'}`}>{symbol}</span>
                            </div>
                            {isSelected && <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>}
                        </div>
                        
                        <div className="flex flex-col items-start">
                            <span className="text-xl font-mono text-white">
                                {price ? `$${price.toLocaleString()}` : 'Loading...'}
                            </span>
                            {price && (
                                <span className={`text-xs flex items-center mt-1 ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                                    {isPositive ? <ArrowUp size={12} /> : <ArrowDown size={12} />}
                                    {Math.abs(change).toFixed(2)}%
                                </span>
                            )}
                        </div>
                    </button>
                );
            };

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 font-sans pb-10">
                    <header className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-10 shadow-lg">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <TrendingUp className="text-blue-500" />
                                <h1 className="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                                    Smart DCA Bot
                                </h1>
                            </div>
                            
                            {/* iOS Style Notification Toggle */}
                            <div className="flex items-center gap-3">
                                <span className={`text-sm font-medium transition-colors ${notificationsEnabled ? 'text-white' : 'text-slate-500'}`}>
                                    {notificationsEnabled ? 'é€šçŸ¥å·²é–‹å•Ÿ' : 'æ¯æ—¥é€šçŸ¥'}
                                </span>
                                <button 
                                    onClick={toggleNotifications}
                                    className={`w-12 h-7 rounded-full p-1 transition-all duration-300 ease-in-out focus:outline-none relative ${
                                        notificationsEnabled ? 'bg-green-500' : 'bg-slate-600'
                                    }`}
                                    title={notificationsEnabled ? "é—œé–‰é€šçŸ¥" : "é–‹å•Ÿé€šçŸ¥"}
                                >
                                    <div 
                                        className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ease-in-out ${
                                            notificationsEnabled ? 'translate-x-5' : 'translate-x-0'
                                        }`} 
                                    />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 space-y-6">
                        
                        <div className="flex gap-4 w-full">
                            <PriceCard 
                                id="bitcoin" 
                                name="Bitcoin" 
                                symbol="BTC" 
                                iconUrl="https://cryptologos.cc/logos/bitcoin-btc-logo.png" 
                            />
                            <PriceCard 
                                id="ethereum" 
                                name="Ethereum" 
                                symbol="ETH" 
                                iconUrl="https://cryptologos.cc/logos/ethereum-eth-logo.png" 
                            />
                        </div>

                        {loading && !historicalData.length ? (
                            <div className="h-64 flex flex-col items-center justify-center text-slate-500 gap-4">
                                <RefreshCw className="animate-spin" size={32} />
                                <p>æ­£åœ¨åŒæ­¥çœŸå¯¦å¸‚å ´æ•¸æ“š...</p>
                            </div>
                        ) : error ? (
                            <div className="bg-red-900/20 border border-red-500/50 text-red-200 p-6 rounded-xl flex items-center gap-4">
                                <AlertTriangle size={24} className="shrink-0" />
                                <div>
                                    <h3 className="font-bold text-lg">æ•¸æ“šè¼‰å…¥å¤±æ•—</h3>
                                    <p className="text-sm opacity-90 my-2">{error}</p>
                                    <div className="text-xs opacity-70 mb-3">
                                        é€™å¯èƒ½æ˜¯å› ç‚º CoinGecko API é™åˆ¶äº†è¨ªå•é »ç‡ (Rate Limit)ï¼Œæˆ–æ˜¯ç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶ (CORS)ã€‚
                                    </div>
                                    <button 
                                        onClick={fetchData} 
                                        className="px-4 py-2 bg-red-800 hover:bg-red-700 rounded text-sm transition-colors"
                                    >
                                        é‡è©¦é€£ç·š
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <React.Fragment>
                                {/* 1. FNG å„€è¡¨æ¿ç¨ç«‹å€å¡Š - ç¢ºä¿ç¨ç«‹é¡¯ç¤º */}
                                <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl flex flex-col items-center">
                                    <h2 className="text-xl font-bold text-slate-200 mb-4">åŠ å¯†è²¨å¹£ææ‡¼èˆ‡è²ªå©ªæŒ‡æ•¸</h2>
                                    <FearGreedGauge 
                                        fngValue={currentFNG?.value} 
                                        classification={suggestion.title.split(' ')[0]} // å‚³é "æ¥µåº¦ææ‡¼" ç­‰ä¸­æ–‡åˆ†é¡
                                    />
                                </div>

                                {/* 2. ç­–ç•¥å»ºè­°å€å¡Š - ä½¿ç”¨åŸæœ‰çš„é¡è‰²é‚Šæ¡†é‚è¼¯ */}
                                <div className={`p-6 rounded-2xl border ${suggestion.border} ${suggestion.bg} relative overflow-hidden transition-all duration-500`}>
                                    <div className="relative z-10 flex flex-col md:flex-row justify-between items-center w-full max-w-lg mx-auto mt-0">
                                        
                                        {/* å»ºè­°æ“ä½œå’Œæè¿° */}
                                        <div className="flex flex-col items-start text-left mb-4 md:mb-0">
                                            <div className="text-sm uppercase tracking-wider opacity-70 mb-1">DCA ç­–ç•¥å»ºè­°</div>
                                            <span className={`text-2xl font-bold ${suggestion.text}`}>
                                                {suggestion.title}
                                            </span>
                                            <p className="mt-2 text-slate-300 max-w-lg text-sm">
                                                {suggestion.desc}
                                            </p>
                                        </div>
                                        
                                        {/* å»ºè­°æ“ä½œ */}
                                        <div className="flex flex-col items-center md:items-end gap-2 min-w-[140px] text-center md:text-right">
                                            <div className="text-sm text-slate-400">ç•¶å‰æ“ä½œ</div>
                                            <div className={`text-xl font-bold ${suggestion.text} border-2 border-current px-4 py-1 rounded-lg whitespace-nowrap`}>
                                                {suggestion.action}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-lg font-semibold flex items-center gap-2">
                                            <TrendingUp size={18} className="text-slate-400" />
                                            åƒ¹æ ¼èµ°å‹¢èˆ‡è²·å…¥è¨Šè™Ÿ ({selectedCoin === 'bitcoin' ? 'BTC' : 'ETH'})
                                        </h2>
                                        <div className="flex items-center gap-4 text-xs">
                                            <div className="flex items-center gap-1">
                                                <span className="w-2 h-2 rounded-full bg-red-500"></span>
                                                <span className="text-slate-400">æ¥µåº¦ææ‡¼ (å¼·åŠ›è²·å…¥)</span>
                                            </div>
                                            <div className="flex items-center gap-1">
                                                <span className="w-2 h-2 rounded-full bg-orange-500"></span>
                                                <span className="text-slate-400">ææ‡¼ (DCA)</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="h-[350px] w-full relative">
                                        {/* ä½¿ç”¨è‡ªå®šç¾© ChartComponent */}
                                        {chartData && <ChartComponent data={chartData} options={chartOptions} />}
                                    </div>
                                    <p className="text-center text-xs text-slate-500 mt-4">
                                        * ç´…é»/æ©˜é»æ¨™è¨˜è™•ä»£è¡¨ç•¶å¤©ææ‡¼æŒ‡æ•¸ä½æ–¼ 40ï¼Œç‚ºæ­·å²å›æ¸¬å»ºè­°çš„è²·å…¥æ™‚æ©Ÿã€‚
                                    </p>
                                </div>

                                <div className="grid md:grid-cols-2 gap-4">
                                    <div className="bg-slate-900 p-5 rounded-xl border border-slate-800">
                                        <h3 className="font-bold text-slate-200 mb-3 flex items-center gap-2">
                                            <Smartphone size={18} />
                                            App é€šçŸ¥æ©Ÿåˆ¶
                                        </h3>
                                        <ul className="space-y-2 text-sm text-slate-400">
                                            <li className="flex gap-2">
                                                <span className="text-blue-500">â€¢</span>
                                                <span>è«‹é»æ“Šå³ä¸Šè§’é–‹é—œé–‹å•Ÿé€šçŸ¥æ¬Šé™ã€‚</span>
                                            </li>
                                            <li className="flex gap-2">
                                                <span className="text-blue-500">â€¢</span>
                                                <span>ç•¶æŒ‡æ•¸ &lt; 25 (æ¥µåº¦ææ‡¼)ï¼šè·³å‡ºå¼·åŠ›è²·å…¥é€šçŸ¥ã€‚</span>
                                            </li>
                                            <li className="flex gap-2">
                                                <span className="text-blue-500">â€¢</span>
                                                <span>ç•¶æŒ‡æ•¸ 26-44 (ææ‡¼)ï¼šè·³å‡ºæ¨™æº– DCA é€šçŸ¥ã€‚ (å·²æ ¹æ“šæœ€æ–°åœ–è¡¨èª¿æ•´)</span>
                                            </li>
                                            <li className="flex gap-2">
                                                <span className="text-blue-500">â€¢</span>
                                                <span>æ¯æ—¥æ—©ä¸Š 8:00 (UTC+8) æ›´æ–°æ•¸æ“šæ™‚è§¸ç™¼ã€‚</span>
                                            </li>
                                        </ul>
                                    </div>

                                    <div className="bg-slate-900 p-5 rounded-xl border border-slate-800">
                                        <h3 className="font-bold text-slate-200 mb-3 flex items-center gap-2">
                                            <Info size={18} />
                                            é—œæ–¼æ•¸æ“šä¾†æº
                                        </h3>
                                        <div className="text-sm text-slate-400 space-y-2">
                                            <p>
                                                <strong>åƒ¹æ ¼æ•¸æ“š:</strong> CoinGecko V3 API (æ¯æ—¥æ”¶ç›¤åƒ¹ & å³æ™‚å ±åƒ¹)
                                            </p>
                                            <p>
                                                <strong>æƒ…ç·’æŒ‡æ¨™:</strong> Alternative.me Crypto Fear & Greed Index
                                            </p>
                                            <p className="text-xs text-slate-500 mt-2 border-t border-slate-800 pt-2">
                                                æœ€å¾Œæ›´æ–°: {lastUpdated ? lastUpdated.toLocaleString() : '-'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </React.Fragment>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
